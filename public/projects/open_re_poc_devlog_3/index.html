<!DOCTYPE html>
<html lang="fr-fr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">OpenRE devlog 3 : Harmonisation des normales | Turbo Tartine Games</title>
<meta property="og:title" content="OpenRE devlog 3 : Harmonisation des normales | Turbo Tartine Games" />
<meta name="twitter:title" content="OpenRE devlog 3 : Harmonisation des normales | Turbo Tartine Games" />
<meta itemprop="name" content="OpenRE devlog 3 : Harmonisation des normales | Turbo Tartine Games" />
<meta name="application-name" content="OpenRE devlog 3 : Harmonisation des normales | Turbo Tartine Games" />
<meta property="og:site_name" content="Turbo Tartine Games" />

<meta name="description" content="devlog 3 du projet OpenRE">
<meta itemprop="description" content="devlog 3 du projet OpenRE" />
<meta property="og:description" content="devlog 3 du projet OpenRE" />
<meta name="twitter:description" content="devlog 3 du projet OpenRE" />

<meta property="og:locale" content="fr-fr" />
<meta name="language" content="fr-fr" />

  <link rel="alternate" hreflang="fr-fr" href="http://localhost:1313/projects/open_re_poc_devlog_3/" title="french" />






<meta name="generator" content="Hugo 0.140.2">

    
    <meta property="og:url" content="http://localhost:1313/projects/open_re_poc_devlog_3/">
  <meta property="og:site_name" content="Turbo Tartine Games">
  <meta property="og:title" content="OpenRE devlog 3 : Harmonisation des normales">
  <meta property="og:description" content="devlog 3 du projet OpenRE">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-07-15T09:38:25+02:00">
    <meta property="article:modified_time" content="2025-07-15T09:38:25+02:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OpenRE devlog 3 : Harmonisation des normales">
  <meta name="twitter:description" content="devlog 3 du projet OpenRE">


    

    <link rel="canonical" href="http://localhost:1313/projects/open_re_poc_devlog_3/">
    <link href="/style.min.d051611d972fbc0c488f4469d3dce0f44403a9e65ca176c7632a4432d42f7634.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Accueil</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Accueil
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/projects/">
                        Projets
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Articles
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/glossary/">
                        Lexique
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        À propos
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">OpenRE devlog 3 : Harmonisation des normales</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-07-15T09:38:25&#43;02:00" itemprop="datePublished"> 15 juil. 2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table des matières</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#i-introduction">I. Introduction</a></li>
    <li><a href="#ii-génération-des-textures">II. Génération des textures</a>
      <ul>
        <li><a href="#1-normale-interactive">1. Normale interactive</a></li>
        <li><a href="#2-normale-déterministe">2. Normale déterministe</a></li>
      </ul>
    </li>
    <li><a href="#iii-réglages">III. Réglages</a>
      <ul>
        <li><a href="#1-normal-packing--unpacking">1. Normal Packing / Unpacking</a></li>
        <li><a href="#2-view-vs-world">2. View vs World</a></li>
        <li><a href="#3-permutations-du-repère">3. Permutations du repère</a></li>
        <li><a href="#4-normalisation">4. Normalisation</a></li>
      </ul>
    </li>
    <li><a href="#iv-conclusion">IV. Conclusion</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <p><a href="/projects/open_re_poc_devlog_2/">⬅️ Vers Précédent : &ldquo;OpenRE devlog 2 : Harmonisation de la profondeur&rdquo;</a></p>
<h2 id="i-introduction">I. Introduction</h2>
<p>Si vous êtes un lecteur du futur et que vous lisez ces develogs d&rsquo;une traite, vous avez sûrement la structure des précédents numéros en tête. Mais si vous les découvrez au fur et à mesure, un petit rappel me semble approprié.</p>
<p>Depuis le début de cette série, nous avons entrepris d&rsquo;harmoniser les différents jeux de textures issus de Blender et Godot qui composent nos G-Buffers déterministes et interactifs. Jusqu&rsquo;ici, nous avons traité :</p>
<ul>
<li>l&rsquo;albédo</li>
<li>la profondeur</li>
</ul>
<p>Pour nous aider dans cette tâche, nous avons mis au point un petit outil que nous appelons &ldquo;l&rsquo;Oracle&rdquo; et qui nous permet de comparer les textures deux à deux. Le résultat de la comparaison prend la forme d&rsquo;une image (que nous appelons &ldquo;prophétie&rdquo;) dans laquelle chaque pixel représente le degré de différence mesuré entre les deux textures sources. Il s&rsquo;interprète comme ceci :</p>
<ul>
<li>pixel blanc : La différecne est maximale</li>
<li>pixel noir : les sources sont identiques</li>
</ul>
<p>Aujourd&rsquo;hui, nous allons nous occuper des textures de normales. Et comme à chaque fois, il y aura :</p>
<ul>
<li>une première partie expliquant comment obtenir les textures avec les deux logiciels</li>
<li>une seconde partie présentant les ajustements effectués pour avoir des textures bien en phase</li>
</ul>
<h2 id="ii-génération-des-textures">II. Génération des textures</h2>
<p>Une fois n&rsquo;est pas coutume, nous allons utiliser une nouvelle passe Cycles dédiée côté déterministe, et une <a href="/pages/glossary/#render-target">Render target</a> avec un <a href="/pages/glossary/#post-process">post-process</a> côté interactif.</p>
<h3 id="1-normale-interactive">1. Normale interactive</h3>
<p>Commençons tout de suite avec le post-process. Cette fois, la texture qui nous intéresse est la  <code>hint_normal_roughness_texture</code>. Voici le code complet :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">depth_texture</span> <span class="o">:</span> <span class="n">hint_normal_roughness_texture</span><span class="p">,</span> <span class="n">repeat_disable</span><span class="p">,</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">normal_roughness_texture</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Rien de particulier ici. On ignore simplement la roughness stockée dans le composant <code>w</code> de la <code>hint_normal_roughness_texture</code> parce qu&rsquo;on n&rsquo;en a pas besoin.</p>
<h3 id="2-normale-déterministe">2. Normale déterministe</h3>
<p>La passe à activer est ici assez évidente. Elle s&rsquo;appelle tout simplement : <code>Normal</code>. Vous commencez surement à être familier avec le procéssus :</p>
<ul>
<li>On active la passe <code>Normal</code> depuis le panneau latéral</li>
<li>On ajoute un pin <code>normal</code> au nœud <code>File Output</code> du <code>Compositor</code></li>
<li>On relie les deux et on appuie sur <code>F12</code> pour générer le rendu</li>
</ul>
<p><a href="/projects/open_re_poc_devlog_3/images/active_normal_pass.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/active_normal_pass.opti.webp" alt="Capture d&rsquo;écran montrant comment activer la normal pass de Cycles"></a></p>
<p>À ma grande surprise, l&rsquo;image obtenue ressemble à ça :</p>
<p><a href="/projects/open_re_poc_devlog_3/images/normal0002_raw.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/normal0002_raw.opti.webp" alt="Capture montrant le resultat buggé de l&rsquo;export de la normal pass de blender"></a></p>
<p>Ce n&rsquo;est évidemment pas ce qu&rsquo;on veut. Je pense qu&rsquo;il s&rsquo;agit d&rsquo;un bug de Blender, car le contournement est pour le moins suspect :</p>
<p><a href="/projects/open_re_poc_devlog_3/images/fix_blend_bug.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/fix_blend_bug.opti.webp" alt="Capture d&rsquo;écran montrant comment fixer le bug d&rsquo;export de la normal pass"></a></p>
<p>Il suffit d&rsquo;ajouter un nœud qui ne fait rien du tout entre les deux pins. Par exemple, le nœud <code>Add</code> dans l&rsquo;illustration ci-dessus qui ajoute à la normale la couleur noire (0, 0, 0). Lorsqu&rsquo;on fait ça, le rendu redevient cohérent :</p>
<p><a href="/projects/open_re_poc_devlog_3/images/raw_d_normal.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/raw_d_normal.opti.webp" alt="Capture montrant la normal pass fixée"></a></p>
<h2 id="iii-réglages">III. Réglages</h2>
<p>Cette fois encore, il a fallu modifier l&rsquo;oracle pour qu&rsquo;il supporte la comparaison des textures de normales. Sans entrer dans les détails, j&rsquo;ai ajouté une fonction de prétraitement pour chacune des textures :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">i_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">i_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">d_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Notez également que nous allons traiter des directions. On va donc changer notre critère de comparaison habituel (distance euclidienne) et utiliser quelque chose de plus pertinent dans ce contexte : l&rsquo;angle entre les vecteurs (que l&rsquo;on projettera sur [0, 1] en le divisant par π).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">compute_normal_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">i_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">d_frag</span><span class="p">,</span> <span class="n">i_frag</span><span class="p">))</span> <span class="o">/</span> <span class="n">PI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="1-normal-packing--unpacking">1. Normal Packing / Unpacking</h3>
<p>Si on compare les textures en l&rsquo;état, on remarque que les couleurs sont très différentes, mais pas seulement. Si on observe la texture déterministe, on constate aussi que :</p>
<ul>
<li>certaines faces sont noires</li>
<li>les faces opposées à une face noire sont systématiquement colorées</li>
</ul>
<p><a href="/projects/open_re_poc_devlog_3/images/first_compare_det_int.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/first_compare_det_int.opti.webp" alt="Comparaison côte à côte des textures de normales interactive et déterministe"></a></p>
<p>Quand on y réfléchit, c&rsquo;est parfaitement normal car, contrairement à une couleur, un vecteur peut avoir des composantes négatives. Lorsqu&rsquo;on essaie de les visualiser, ces dernières sont clampées à 0, et un vecteur n&rsquo;ayant que des valeurs négatives apparaît donc noir.</p>
<p>Non seulement ce n&rsquo;est pas pratique pour la visualisation, mais surtout la plupart des formats d&rsquo;images ne permettent pas d&rsquo;encoder des valeurs négatives. Ici ce n&rsquo;est pas le cas car on utilise <code>EXR</code>, mais avec un autre format, les valeurs seraient clampées à l&rsquo;export et la donnée serait tout simplement perdue.</p>
<p>La solution usuelle à ce problème est de projeter les composantes des normales de l&rsquo;intervalle [-1, 1] vers l&rsquo;intervalle [0, 1] avant d&rsquo;exporter. On appelle ce procédé le &ldquo;normal packing&rdquo;. Par la suite, pour retrouver nos normales et faire nos calculs dans le shader après import, il suffit d&rsquo;effectuer l&rsquo;opération inverse (&ldquo;normal unpacking&rdquo;).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// ... Normal generation ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">packed_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">normal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ... Export ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ... Import ...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">unpacked_normal</span> <span class="o">=</span> <span class="n">packed_normal</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ... Shader computations ...</span>
</span></span></code></pre></div><p>Nous avons donc une texture déterministe &ldquo;unpacked&rdquo; et une texture interactive &ldquo;packed&rdquo;. Ce qui nous arrangerait, ce serait que les deux soient &ldquo;packed&rdquo; pour la visualisation et &ldquo;unpacked&rdquo; pour le calcul de différence. Nous allons donc packer la texture déterministe dans <code>pre_process_d_normal</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">d_normal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>	<span class="c1">// Pack</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Et dépacker les deux avant le calcul de différence dans <code>compute_normal_difference</code> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">compute_normal_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">i_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_frag</span> <span class="o">=</span> <span class="n">d_frag</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack (previously packed in pre_process_d_normal())</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_frag</span> <span class="o">=</span> <span class="n">i_frag</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">d_frag</span><span class="p">,</span> <span class="n">i_frag</span><span class="p">))</span> <span class="o">/</span> <span class="n">PI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Les couleurs sont toujours aux fraises, mais on a fait un premier pas. Et surtout, on peut maintenant visualiser correctement la texture déterministe sans avoir à deviner ce qu&rsquo;il se passe dans les zones noires.</p>
<p><a href="/projects/open_re_poc_devlog_3/images/packed_compare_det_int.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/packed_compare_det_int.opti.webp" alt="Comparaison côte à côte des textures de normales interactive et déterministe (packée)"></a></p>
<h3 id="2-view-vs-world">2. View vs World</h3>
<p>Une question qu&rsquo;il faut toujours se poser quand on écrit un <a href="/pages/glossary/#shader">shader</a>, c&rsquo;est : &ldquo;dans quel espace sont exprimées mes données&rdquo;. En effet, il y a deux écoles :</p>
<ul>
<li>faire les calculs en <code>VIEW_SPACE</code> (l&rsquo;espace de la caméra)</li>
<li>faire les calculs en <code>WORLD_SPACE</code> (l&rsquo;espace de la scène)</li>
</ul>
<p>Les deux options sont parfaitement viables, mais évidemment, il faut choisir et s&rsquo;assurer que toutes les données soient bien conformes à ce choix (et les changer d&rsquo;espace si ce n&rsquo;est pas le cas). Il est donc primordial de savoir dans quel espace Blender et Godot expriment leurs normales.</p>
<p>J&rsquo;ai été surpris de ne pas trouver l&rsquo;info dans leurs documentations respectives. Mais heureusement, ce n&rsquo;est pas très difficile à déterminer. Il suffit de faire varier l&rsquo;angle de la caméra et d&rsquo;observer les couleurs qui représentent les normales.</p>
<ul>
<li>Si les couleurs varient avec l&rsquo;angle, on est en <code>VIEW_SPACE</code></li>
<li>Si les couleurs ne bougent pas, on est en <code>WORLD_SPACE</code></li>
</ul>
<p>Il se trouve que Blender est en <code>WORLD_SPACE</code> et Godot en <code>VIEW_SPACE</code>. Je préfère travailler en <code>WORLD_SPACE</code>. On va donc utiliser <code>pre_process_i_normal</code> pour effectuer le changement d&rsquo;espace côté Godot :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">i_normal</span><span class="p">,</span> <span class="n">mat4</span> <span class="n">inv_view_matrix</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="n">i_normal</span> <span class="o">=</span> <span class="n">i_normal</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack for space switch</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">inv_view_matrix</span> <span class="o">*</span> <span class="k">vec4</span><span class="p">(</span><span class="n">i_normal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">i_normal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>		<span class="c1">// Repack for visualisation</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Vous noterez qu&rsquo;on effectue un &ldquo;unpacking&rdquo; avant le changement d&rsquo;espace, ce qui est normal. Mais il ne faut pas oublier de &ldquo;repack&rdquo; juste après pour pouvoir visualiser la texture correctement.</p>
<p>Par ailleurs, si vous vous demandez comment on obtient le paramètre <code>inv_view_matrix</code> qui nous permet de changer d&rsquo;espace, c&rsquo;est très simple. Godot expose à ses shaders la matrice <code>INV_VIEW_MATRIX</code>. Mais elle n&rsquo;est accessible que depuis <code>void fragment()</code> (le main du <a href="/pages/glossary/#fragment-shader">fragment shader</a> dans le langage de shading de Godot). Il faut donc la passer en paramètre.</p>
<p>Observons maintenant la différence entre les deux espaces :</p>
<p><a href="/projects/open_re_poc_devlog_3/images/compare_view_world.gif"><img src="/projects/open_re_poc_devlog_3/images/compare_view_world.gif" alt="Comparaison animée des textures déterministes en world space et view space"></a></p>
<p>Elle est visible mais pas très prononcée. Cela s&rsquo;explique par le fait que notre caméra est presque alignée avec le repère. Dans ce cas, <code>VIEW_SPACE</code> et <code>WORLD_SPACE</code> sont très proches l&rsquo;un de l&rsquo;autre vis-à-vis de la rotation. Cela aurait été beaucoup plus flagrant si la caméra regardait dans une autre direction. D&rsquo;où l&rsquo;importance d&rsquo;avoir à terme plusieurs scènes de test car sans s&rsquo;en rendre compte, on peut très vite se placer dans des cas particuliers.</p>
<h3 id="3-permutations-du-repère">3. Permutations du repère</h3>
<p>Évidemment, Blender et Godot n&rsquo;utilisent pas le même repère. Le &ldquo;up vector&rdquo; de Godot est l&rsquo;axe Y, alors que celui de Blender est l&rsquo;axe Z. C&rsquo;est la raison pour laquelle les couleurs représentant les normales ne matchent pas : les canaux sont en quelque sorte inversés. Il faut donc réorganiser tout ça dans <code>pre_process_d_normal</code>. En comparant les gizmos des deux logiciels, je suis arrivé à la conclusion que la bonne permutation était la suivante :</p>
<img alt="Illustration montrant les repères des 2 logiciels de part et d'autre d'un flêche horizontal annotée '(x, y, z) => (x, z, -y) ?'" src="./images/blenderToGodot.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">d_normal</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">d_normal</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">d_normal</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>	<span class="c1">// Permut</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">d_normal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>							<span class="c1">// Pack</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Malheureusement, l&rsquo;Oracle n&rsquo;avait pas l&rsquo;air d&rsquo;accord. En effet, sur la prophétie, on peut voir que le sol et le mur gauche de la cornell-box ne sont pas noirs, indiquant que les vecteurs up et right ne sont pas en phase.</p>
<p><a href="/projects/open_re_poc_devlog_3/images/no_normalize.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/no_normalize.opti.webp" alt="1er prophecie de l&rsquo;oracle. Le mur gauche ainsi que le sol sont trè claires"></a></p>
<p>Ma vie étant visiblement un mensonge, j&rsquo;ai essayé d&rsquo;autres permutations un peu au hasard. Vous savez, ce moment où l&rsquo;on ne comprend pas son erreur et où l&rsquo;on commence à changer un signe par-ci, inverser des termes par-là&hellip; (je sens d&rsquo;ici les regards désapprobateurs, mais je sais que vous le faites aussi 😅).</p>
<p>Comme souvent, cela ne m&rsquo;a pas mené bien loin. Mais cela ne veut pas dire que le &ldquo;random programming&rdquo; soit mauvais en soi. Il faut juste le faire bien, c&rsquo;est-à-dire guider par un raisonnement et non par la flemme.</p>
<p>Il n&rsquo;y a que 48 permutations possibles. Ce n&rsquo;est pas la mer à boire. Si je suis capable de reconnaître la bonne à coup sûr, j&rsquo;ai juste besoin d&rsquo;une moulinette pour itérer rapidement sur toutes les entrées. Cette moulinette, la voici :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Applique une permutation parmis les 48 possible</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">_dbg_normal_permut</span><span class="p">(</span><span class="k">vec3</span> <span class="n">normal_src</span><span class="p">,</span> <span class="k">int</span> <span class="n">permut_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">permut_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mo">0</span> <span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">2</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">3</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">4</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">5</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">42</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">43</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">44</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">45</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">46</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">47</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Uniform permetant de selectionner la permutation au runtime</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">dbg_permut_idx</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// Application de la permutation selectionnée</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal</span> <span class="o">=</span> <span class="n">_dbg_normal_permut</span><span class="p">(</span><span class="n">d_normal</span><span class="p">,</span> <span class="n">dbg_permut_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="p">(</span><span class="n">d_normal</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">;</span>		<span class="c1">// Pack</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>À partir de là, il suffit de faire play, de régler le <code>visualisation_mode</code> de l&rsquo;oracle sur <code>D_TEXTURE_ONLY</code> et d&rsquo;incrémenter <code>dbg_permut_idx</code> dans l&rsquo;éditeur jusqu&rsquo;à ce que l&rsquo;image soit noire.</p>
<p><a href="/projects/open_re_poc_devlog_3/images/all_permuts.webp"><img src="/projects/open_re_poc_devlog_3/images/all_permuts.webp" alt="Capture d&rsquo;écran montrant comment fixer le bug d&rsquo;export de la normal pass"></a></p>
<p>Bon, d&rsquo;accord, l&rsquo;image 11 n&rsquo;est pas complètement noire, mais elle sort quand même bien du lot :</p>
<ul>
<li>Elle est globalement plus sombre.</li>
<li>C&rsquo;est la seule à n&rsquo;avoir aucune face complètement blanche.</li>
<li>Elle ressemble quand même beaucoup à la première permutation que nous avons essayée&hellip; C&rsquo;est quoi la formule ?&hellip;</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Applique une permutation parmis les 48 possible</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">_dbg_normal_permut</span><span class="p">(</span><span class="k">vec3</span> <span class="n">normal_src</span><span class="p">,</span> <span class="k">int</span> <span class="n">permut_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">switch</span><span class="p">(</span><span class="n">permut_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="n">case</span> <span class="mi">11</span><span class="o">:</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">normal_src</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">normal_src</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">normal_src</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="c1">// ...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Ok&hellip; c&rsquo;est exactement la même en fait&hellip; Maintenant qu&rsquo;on a comparé l&rsquo;entrée avec toutes les autres, ça paraît évident : on était bons depuis le début. Le problème ne venait pas d&rsquo;une erreur de permutation des axes. C&rsquo;était autre chose.</p>
<h3 id="4-normalisation">4. Normalisation</h3>
<p>J&rsquo;ai mis un certain temps à résoudre l&rsquo;énigme. J&rsquo;ai même envisagé l&rsquo;idée de ressortir la carte &ldquo;Good Enough&rdquo;. Après tout, le présage n&rsquo;est pas bien pire que celui qu&rsquo;on avait accepté pour l&rsquo;albédo, et quand on compare les textures actuelles, ils est quasi impossible de les distinguer.</p>
<p><a href="/projects/open_re_poc_devlog_3/images/no_normalize_comp.gif"><img src="/projects/open_re_poc_devlog_3/images/no_normalize_comp.gif" alt="Comparaison animée des textures interactive et déterministe en l&rsquo;état"></a></p>
<p>Mais dans le cas des normales, on ne peut pas se contenter d’un jugement à l&rsquo;œil. On les représente par des couleurs pour pouvoir les visualiser facilement, mais il faut garder à l&rsquo;esprit que ce sont en réalité des données mathématiques qui interviennent dans des calculs complexes. Le risque d&rsquo;accumuler de l&rsquo;erreur au fil des opérations est trop grand. Il faut faire mieux !</p>
<p>Le souci était en fait tout bête. Pour calculer l&rsquo;angle entre les vecteurs dans <code>compute_normal_difference</code> la formule devrait être :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">(</span><span class="n">v2</span><span class="p">));</span>
</span></span></code></pre></div><p>Mais dans notre cas, les vecteurs sont des normales. Leur norme est donc en principe égale à 1. Le dénominateur peut donc être ignoré, c&rsquo;est pourquoi j&rsquo;utilise la version simplifiée :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">));</span>
</span></span></code></pre></div><p>J&rsquo;ignore pourquoi, mais il s&rsquo;avère que les normales fournies par Blender et Godot ne sont pas toujours de norme 1. Pour le mettre en évidence, j&rsquo;ai temporairement modifié les fonctions <code>pre_process_i_normal</code> et <code>pre_process_d_normal</code> afin que l&rsquo;on puisse visualiser l&rsquo;erreur grossie 100 fois.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">i_normal</span><span class="p">,</span> <span class="n">mat4</span> <span class="n">inv_view_matrix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal</span> <span class="o">=</span> <span class="n">i_normal</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">norm_err</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">length</span><span class="p">(</span><span class="n">i_normal</span><span class="p">))</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">norm_err</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>	
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">norm_err</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">length</span><span class="p">(</span><span class="n">d_normal</span><span class="p">))</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">norm_err</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">,</span> <span class="n">norm_err</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Le résultat est sans appel. Dans un cas comme dans l&rsquo;autre, les normales ne sont pas toujours unitaires :</p>
<p><a href="/projects/open_re_poc_devlog_3/images/err_comp.opti.webp"><img src="/projects/open_re_poc_devlog_3/images/err_comp.opti.webp" alt="Comparaison côte à côte des erreures de taille de normal grossies 100x. A gauche, blender est mauvais principalement sur les angles. A droite godot est bruité sur les surface courbe et sur les murs de gauche et le sol produites"></a></p>
<p>Si l&rsquo;on normalise les vecteurs avant le calcul de l&rsquo;angle, on obtient un résultat de bien meilleure qualité :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">compute_normal_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">i_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_frag</span> <span class="o">=</span> <span class="n">d_frag</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_frag</span> <span class="o">=</span> <span class="n">i_frag</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>	<span class="c1">// Unpack</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="n">d_frag</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">d_frag</span><span class="p">);</span>		<span class="c1">// Fix norm err</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_frag</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">i_frag</span><span class="p">);</span>		<span class="c1">// Fix norm err</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">d_frag</span><span class="p">,</span> <span class="n">i_frag</span><span class="p">))</span> <span class="o">/</span> <span class="n">PI</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">angle</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><a href="/projects/open_re_poc_devlog_3/images/normalize.PNG"><img src="/projects/open_re_poc_devlog_3/images/normalize.PNG" alt="2nd prophecie de l&rsquo;oracle. Tout est bien noir à l&rsquo;exception des contours. On voit apparaitre de légers paternes semblant suivre la géométrie des faces sur les surfaces courbes"></a></p>
<p>On notera la présence de motifs sur les surfaces courbes. Les motifs semblent suivre les <a href="/pages/glossary/#face">face</a> qui composent la géométrie du <a href="/pages/glossary/#mesh">mesh</a>. Je pense que ça vient de la façon dont les deux logiciels calculent les normales des <a href="/pages/glossary/#vertex">vertex</a>. C&rsquo;est toujours plus ou moins une moyenne des normales des faces adjacentes, mais il existe plusieurs heuristiques pour pondérer cette moyenne (prorata des surfaces, des angles, mix des deux, etc.). Godot et Blender n&rsquo;utilisent certainement pas la même, mais ce ne sera pas un problème pour nous. Si notre bottleneck est l&rsquo;heuristique choisie, on peut s&rsquo;arrêter là. On est bien assez précis.</p>
<h2 id="iv-conclusion">IV. Conclusion</h2>
<p>L&rsquo;harmonisation des normales aura été plutôt facile. Mis à part le coup des normes non unitaires et le possible bug de Blender, je m&rsquo;attendais à peu près à tous les réglages effectués. Les questions d&rsquo;espace, de repère ainsi que ces histoires de packing sont en effet assez usuelles en programmation graphique. Ce sont des pièges auxquels on finit par penser naturellement après être tombé dedans 10 fois.</p>
<p>Nous disposons donc désormais d&rsquo;une calibration satisfaisante de Blender et Godot pour les maps suivantes :</p>
<ul>
<li>albédo</li>
<li>depth</li>
<li>normales</li>
</ul>
<p>Ce sont les données minimales nécessaires à une première implémentation de la lumière. On va donc pouvoir laisser l&rsquo;Oracle un peu tranquille et commencer à intégrer de vrais éléments interactifs par-dessus un arrière-plan déterministe et voir comment on gère l&rsquo;illumination dans les deux sens.</p>
<p>C&rsquo;est donc dans le prochain numéro que les pièces vont enfin commencer à s&rsquo;assembler. J&rsquo;ai hâte de trouver un peu de temps pour m&rsquo;y atteler&hellip; alors à très vite, je l&rsquo;espère !</p>

            </div>
        </article>
<hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "turbo-tartine-games-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/J-Ponzo" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://jponzo.itch.io" target="_blank" rel="noopener noreferrer me"
    title="Itchio">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 245.371 220.736">
    <path
        d="M31.99 1.365C21.287 7.72.2 31.945 0 38.298v10.516C0 62.144 12.46 73.86 23.773 73.86c13.584 0 24.902-11.258 24.903-24.62 0 13.362 10.93 24.62 24.515 24.62 13.586 0 24.165-11.258 24.165-24.62 0 13.362 11.622 24.62 25.207 24.62h.246c13.586 0 25.208-11.258 25.208-24.62 0 13.362 10.58 24.62 24.164 24.62 13.585 0 24.515-11.258 24.515-24.62 0 13.362 11.32 24.62 24.903 24.62 11.313 0 23.773-11.714 23.773-25.046V38.298c-.2-6.354-21.287-30.58-31.988-36.933C180.118.197 157.056-.005 122.685 0c-34.37.003-81.228.54-90.697 1.365zm65.194 66.217a28.025 28.025 0 0 1-4.78 6.155c-5.128 5.014-12.157 8.122-19.906 8.122a28.482 28.482 0 0 1-19.948-8.126c-1.858-1.82-3.27-3.766-4.563-6.032l-.006.004c-1.292 2.27-3.092 4.215-4.954 6.037a28.5 28.5 0 0 1-19.948 8.12c-.934 0-1.906-.258-2.692-.528-1.092 11.372-1.553 22.24-1.716 30.164l-.002.045c-.02 4.024-.04 7.333-.06 11.93.21 23.86-2.363 77.334 10.52 90.473 19.964 4.655 56.7 6.775 93.555 6.788h.006c36.854-.013 73.59-2.133 93.554-6.788 12.883-13.14 10.31-66.614 10.52-90.474-.022-4.596-.04-7.905-.06-11.93l-.003-.045c-.162-7.926-.623-18.793-1.715-30.165-.786.27-1.757.528-2.692.528a28.5 28.5 0 0 1-19.948-8.12c-1.862-1.822-3.662-3.766-4.955-6.037l-.006-.004c-1.294 2.266-2.705 4.213-4.563 6.032a28.48 28.48 0 0 1-19.947 8.125c-7.748 0-14.778-3.11-19.906-8.123a28.025 28.025 0 0 1-4.78-6.155 27.99 27.99 0 0 1-4.736 6.155 28.49 28.49 0 0 1-19.95 8.124c-.27 0-.54-.012-.81-.02h-.007c-.27.008-.54.02-.813.02a28.49 28.49 0 0 1-19.95-8.123 27.992 27.992 0 0 1-4.736-6.155zm-20.486 26.49l-.002.01h.015c8.113.017 15.32 0 24.25 9.746 7.028-.737 14.372-1.105 21.722-1.094h.006c7.35-.01 14.694.357 21.723 1.094 8.93-9.747 16.137-9.73 24.25-9.746h.014l-.002-.01c3.833 0 19.166 0 29.85 30.007L210 165.244c8.504 30.624-2.723 31.373-16.727 31.4-20.768-.773-32.267-15.855-32.267-30.935-11.496 1.884-24.907 2.826-38.318 2.827h-.006c-13.412 0-26.823-.943-38.318-2.827 0 15.08-11.5 30.162-32.267 30.935-14.004-.027-25.23-.775-16.726-31.4L46.85 124.08C57.534 94.073 72.867 94.073 76.7 94.073zm45.985 23.582v.006c-.02.02-21.863 20.08-25.79 27.215l14.304-.573v12.474c0 .584 5.74.346 11.486.08h.006c5.744.266 11.485.504 11.485-.08v-12.474l14.304.573c-3.928-7.135-25.79-27.215-25.79-27.215v-.006l-.003.002z" />
</svg>
</a>
<a href="https://@turbotartine.bsky.social" target="_blank" rel="noopener noreferrer me"
    title="Bluesky">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
    d="M11.999,10.236c0.321,-0.524 0.916,-1.507 1.405,-2.376c0.755,-1.344 1.692,-2.852 2.869,-4.028c1.283,-1.281 2.845,-2.171 4.739,-2.171c1.144,-0 1.864,0.585 2.299,1.497c0.486,1.017 0.545,2.551 0.51,3.883c-0.051,1.945 -0.232,3.337 -0.505,4.275c-0.229,0.786 -0.543,1.303 -0.878,1.615c-0.892,0.833 -1.8,1.263 -2.634,1.484c0.029,0.018 0.056,0.036 0.084,0.055c0.528,0.367 0.823,0.79 1.081,1.107c0.648,0.794 0.644,1.795 0.23,2.784c-0.481,1.151 -1.533,2.279 -2.12,2.773c-1.389,1.171 -2.506,1.362 -3.383,1.133c-0.88,-0.23 -1.59,-0.932 -2.156,-1.826c-0.45,-0.71 -0.817,-1.537 -1.176,-2.186c-0.115,-0.208 -0.302,-0.455 -0.406,-0.587c-0.02,0.019 -0.04,0.04 -0.056,0.058c-0.121,0.145 -0.234,0.328 -0.349,0.531c-0.363,0.644 -0.721,1.463 -1.157,2.166c-0.555,0.895 -1.252,1.597 -2.12,1.825c-0.863,0.227 -1.97,0.037 -3.363,-1.136c-0.586,-0.494 -1.638,-1.622 -2.119,-2.773c-0.414,-0.989 -0.418,-1.99 0.229,-2.784c0.258,-0.317 0.554,-0.74 1.082,-1.106c0.027,-0.019 0.055,-0.038 0.084,-0.056c-0.834,-0.221 -1.742,-0.651 -2.634,-1.484c-0.335,-0.312 -0.649,-0.829 -0.878,-1.615c-0.273,-0.938 -0.454,-2.33 -0.505,-4.275c-0.036,-1.332 0.024,-2.866 0.509,-3.883c0.435,-0.912 1.156,-1.497 2.3,-1.497c2.32,0 4.109,1.203 5.494,2.808c1.272,1.474 2.195,3.283 2.9,4.643c0.231,0.447 0.436,0.84 0.624,1.146Zm-0.01,5.653l0.296,0.031l0.271,0.086c0.208,0.088 0.413,0.229 0.607,0.428c0.455,0.467 0.882,1.369 1.36,2.284c0.249,0.477 0.518,0.958 0.841,1.339c0.231,0.274 0.483,0.502 0.805,0.569c0.488,0.103 1.052,-0.157 1.811,-0.797c0.452,-0.38 1.274,-1.239 1.645,-2.126c0.155,-0.371 0.265,-0.75 0.022,-1.048c-0.179,-0.22 -0.366,-0.529 -0.732,-0.783c-0.536,-0.372 -1.356,-0.51 -1.905,-0.654c-0.405,-0.106 -0.715,-0.234 -0.88,-0.355l-0.284,-0.303l-0.135,-0.367l-0.008,-0.211l0.035,-0.196l0.078,-0.195l0.142,-0.209l0.198,-0.181l0.296,-0.154c0.151,-0.055 0.348,-0.092 0.587,-0.104c0.815,-0.042 2.571,0.294 4.235,-1.259c0.171,-0.159 0.288,-0.445 0.404,-0.845c0.246,-0.843 0.391,-2.096 0.438,-3.843c0.024,-0.91 0.026,-1.938 -0.208,-2.738c-0.142,-0.486 -0.367,-0.891 -0.896,-0.891c-1.675,0 -2.974,0.983 -4.031,2.21c-1.179,1.369 -2.058,3.057 -2.752,4.321c-0.483,0.88 -0.902,1.573 -1.25,1.916c-0.088,0.086 -0.174,0.157 -0.257,0.214l-0.221,0.125l-0.228,0.078l-0.267,0.031l-0.274,-0.034l-0.231,-0.083l-0.219,-0.132c-0.081,-0.058 -0.164,-0.131 -0.248,-0.22c-0.327,-0.343 -0.718,-1.037 -1.174,-1.917c-0.654,-1.262 -1.497,-2.948 -2.676,-4.314c-1.067,-1.236 -2.417,-2.217 -4.203,-2.217c-0.53,0 -0.754,0.405 -0.896,0.891c-0.234,0.8 -0.232,1.828 -0.208,2.738c0.046,1.747 0.192,3 0.438,3.843c0.116,0.4 0.233,0.686 0.403,0.845c1.665,1.553 3.421,1.217 4.235,1.259c0.24,0.012 0.437,0.049 0.588,0.104l0.295,0.154l0.199,0.181l0.142,0.209l0.078,0.195l0.035,0.196l-0.009,0.211l-0.135,0.368l-0.283,0.303c-0.165,0.12 -0.476,0.248 -0.88,0.355c-0.549,0.144 -1.369,0.281 -1.905,0.653c-0.366,0.254 -0.554,0.564 -0.732,0.783c-0.243,0.298 -0.133,0.677 0.022,1.048c0.371,0.887 1.193,1.746 1.645,2.127c0.757,0.637 1.311,0.9 1.789,0.8c0.311,-0.066 0.55,-0.29 0.772,-0.557c0.315,-0.381 0.577,-0.86 0.822,-1.337c0.394,-0.763 0.752,-1.521 1.138,-2.01c0.431,-0.544 0.929,-0.815 1.455,-0.815Z" style="fill-rule:nonzero;"/>
</svg>
</a>
<a href="https://mastodon.gamedev.place/@TurboTartine" target="_blank" rel="noopener noreferrer me"
    title="Mastodon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M21.58 13.913c-.29 1.469-2.592 3.121-5.238 3.396-1.379.184-2.737.368-4.185.276-2.368-.092-4.237-.551-4.237-.551 0 .184.014.459.043.643.308 2.294 2.317 2.478 4.22 2.57 1.922 0 3.633-.46 3.633-.46l.079 1.653s-1.344.734-3.738.918c-1.32.091-2.96-.092-4.869-.551-4.14-1.102-4.853-5.507-4.961-10.005-.034-1.285-.013-2.57-.013-3.58 0-4.589 3-5.966 3-5.966 1.513-.734 4.11-1.01 6.808-1.01h.067c2.699 0 5.296.276 6.81 1.01 0 0 3 1.377 3 5.967 0 0 .037 3.304-.419 5.69"
        stroke="currentColor" />
    <path
        d="M17.832 8.633v5h-1.978V8.78c0-1.023-.43-1.542-1.29-1.542-.95 0-1.427.616-1.427 1.834v2.655H11.17V9.072c0-1.218-.476-1.834-1.427-1.834-.86 0-1.29.52-1.29 1.542v4.852H6.475V8.633c0-1.022.26-1.834.782-2.434.538-.6 1.243-.909 2.118-.909 1.012 0 1.779.39 2.286 1.169l.492.827.493-.827c.507-.78 1.274-1.169 2.286-1.169.875 0 1.58.308 2.118.909.522.6.782 1.412.782 2.434"
        fill="currentColor" stroke="none" />
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 J-Ponzo(TurboTartine).
        Propulsé par <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Aller en haut" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
