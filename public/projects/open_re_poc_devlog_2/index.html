<!DOCTYPE html>
<html lang="fr-fr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">OpenRE devlog 2 : Harmonisation de la profondeur | Turbo Tartine Games</title>
<meta property="og:title" content="OpenRE devlog 2 : Harmonisation de la profondeur | Turbo Tartine Games" />
<meta name="twitter:title" content="OpenRE devlog 2 : Harmonisation de la profondeur | Turbo Tartine Games" />
<meta itemprop="name" content="OpenRE devlog 2 : Harmonisation de la profondeur | Turbo Tartine Games" />
<meta name="application-name" content="OpenRE devlog 2 : Harmonisation de la profondeur | Turbo Tartine Games" />
<meta property="og:site_name" content="Turbo Tartine Games" />

<meta name="description" content="devlog 2 du projet OpenRE">
<meta itemprop="description" content="devlog 2 du projet OpenRE" />
<meta property="og:description" content="devlog 2 du projet OpenRE" />
<meta name="twitter:description" content="devlog 2 du projet OpenRE" />

<meta property="og:locale" content="fr-fr" />
<meta name="language" content="fr-fr" />

  <link rel="alternate" hreflang="fr-fr" href="http://localhost:1313/projects/open_re_poc_devlog_2/" title="french" />






<meta name="generator" content="Hugo 0.137.0">

    
    <meta property="og:url" content="http://localhost:1313/projects/open_re_poc_devlog_2/">
  <meta property="og:site_name" content="Turbo Tartine Games">
  <meta property="og:title" content="OpenRE devlog 2 : Harmonisation de la profondeur">
  <meta property="og:description" content="devlog 2 du projet OpenRE">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-05-28T09:01:41+02:00">
    <meta property="article:modified_time" content="2025-05-28T09:01:41+02:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OpenRE devlog 2 : Harmonisation de la profondeur">
  <meta name="twitter:description" content="devlog 2 du projet OpenRE">


    

    <link rel="canonical" href="http://localhost:1313/projects/open_re_poc_devlog_2/">
    <link href="/style.min.d051611d972fbc0c488f4469d3dce0f44403a9e65ca176c7632a4432d42f7634.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Accueil</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Accueil
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/projects/">
                        Projets
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Articles
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/glossary/">
                        Lexique
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        À propos
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">OpenRE devlog 2 : Harmonisation de la profondeur</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-05-28T09:01:41&#43;02:00" itemprop="datePublished"> 28 mai 2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table des matières</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#i-introduction">I. Introduction</a></li>
    <li><a href="#ii-génération-des-textures">II. Génération des textures</a>
      <ul>
        <li><a href="#1-depth-intéractive">1. Depth intéractive</a></li>
        <li><a href="#2-depth-déterministe">2. Depth déterministe</a></li>
      </ul>
    </li>
    <li><a href="#iii-réglages">III. Réglages</a>
      <ul>
        <li><a href="#1-channel-packing">1. Channel packing</a></li>
        <li><a href="#2-délinéarisation">2. Délinéarisation</a></li>
        <li><a href="#3-use-hdr-2d">3. Use HDR 2D</a></li>
        <li><a href="#4-mist-or-not-mist">4. Mist or not Mist</a></li>
      </ul>
    </li>
    <li><a href="#iv-retour-sur-les-espaces-de-couleur">IV. Retour sur les espaces de couleur</a></li>
    <li><a href="#v-conclusion">V. Conclusion</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <h2 id="i-introduction">I. Introduction</h2>
<p>Le mois dernier nous avions utilisé l&rsquo;oracle pour harmoniser les textures d&rsquo;albédo intéractive et déterminises. Aujourd&rsquo;hui, on va faire la même chose avec la profondeur.</p>
<p>Travail similaire, structure similaire. Je vais commencer par expliquer d&rsquo;où viennent nos textures, puis on commencera les réglages en surveillant les prophecies de l&rsquo;oracle à chaque étape.</p>
<p>Je ne détaillerai pas autant que d&rsquo;habitude les action effectuées dans Blender et Godot. D&rsquo;abord pour rester raccord avec ma volonté de concision et de simplicité (qui semble avoir été apréciée d&rsquo;après les retours que j&rsquo;ai eu). Mais aussi parce que ces actions seront très similaires à ce qu&rsquo;on a fait dans le numéro précédent. On s&rsquo;économisera donc les description un peu lourdes.</p>
<p>Ce sera l&rsquo;occasion de s&rsquo;étandre un peu plus sur les peripeties sans pour autant déborder du format &ldquo;moins de 10 min&rdquo;. Car comme vous allez le découvrir, cet épisode est assez riche en rebondisements.</p>
<h2 id="ii-génération-des-textures">II. Génération des textures</h2>
<p>Pour générer nos textures nous allons donc nous appuyer sur ce que nous avions fait avec l&rsquo;albédo dans le numéro précédent :</p>
<ul>
<li>Render target avec un post-process specifique dans la scene Godot pour l&rsquo;interactive</li>
<li>Export de la passe blender correspondant à la depth pour la déterministe</li>
</ul>
<p>Sauf indication contraire, on conservera les réglages déjà effectués (format EXR, pas de compression VRAM etc&hellip;)</p>
<h3 id="1-depth-intéractive">1. Depth intéractive</h3>
<p>Le post-process permettant d&rsquo;afficher la profondeur est très similaire à celui de l&rsquo;albédo. En réalité il faut simplement remplacer <code>hint_screen_texture</code> par <code>hint_depth_texture</code> dans les hints du <code>uniform sampler2D</code> (on changera aussi son nom parce qu&rsquo;on est pas des bêtes)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">depth_texture</span> <span class="o">:</span> <span class="n">hint_depth_texture</span><span class="p">,</span> <span class="n">repeat_disable</span><span class="p">,</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">texture</span><span class="p">(</span><span class="n">depth_texture</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">rgb</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Il faudra également penser à <strong>ne pas</strong> régler le flag <code>Debug Draw</code> sur <code>Unshaded</code> cette fois ci. Nous avoins fait ça pour retirer l&rsquo;éclérage de la <code>hint_screen_texture</code> afin de ne garder que l&rsquo;albédo. Mais c&rsquo;était un workaround spécifique. La <code>hint_depth_texture</code> est déjà l&rsquo;information dont on a besoin. Il n&rsquo;y a donc rien de plus à faire ici pour l&rsquo;instant.</p>
<h3 id="2-depth-déterministe">2. Depth déterministe</h3>
<p>Pour la profondeur déterministe par contre ce n&rsquo;est pas aussi simple. A prèmière vue, deux passes pourraient correspondre à ce qu&rsquo;on cherche : la <code>Z</code> et la <code>Mist</code>. La documentation de Blender ne m&rsquo;ayant pas vraiment aidé à les départager j&rsquo;ai décidé de les rendre toutes les 2 pour les comparer. Voici ce que j&rsquo;ai obtenu :</p>
<p><a href="/projects/open_re_poc_devlog_2/images/z_mist_naive_export.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/z_mist_naive_export.opti.webp"></a></p>
<p>Ne comprenant pas vraiment ce que j&rsquo;étais sensé voir avec la <code>Z</code> j&rsquo;ai choisi la <code>Mist</code> par élimination. J&rsquo;ai donc ajouté un pin <code>depth</code> au noeud <code>File Output</code> déjà présant et je l&rsquo;ai relié au pin <code>Mist</code> apparu sur le noeud <code>Render Layer</code> après activation de la passe correspondante.</p>
<p><a href="/projects/open_re_poc_devlog_2/images/mist_compositor.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/mist_compositor.opti.webp"></a></p>
<p>Les textures d&rsquo;albédo et de profondeur sont désormais régénrées automatiquement à chaque rendu.</p>
<h2 id="iii-réglages">III. Réglages</h2>
<p>Pour supporter un deuxieme jeu de textures à comparer, il a fallu adapter un peu l&rsquo;oracle. On fera l&rsquo;impasse sur ces modifictions car elles sont plutôt triviales (et donc pas très interessantes).</p>
<p>Notez simplement que j&rsquo;ai ajouté une fonction <code>pre_processd_d_depth</code> qui nous permettra d&rsquo;agir sur la texture de profondeur déterministe avant les étapes d&rsquo;affichage et de différence. Pour l&rsquo;instant cette fonction ne fait rien :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_processd_d_depth</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_depth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">d_depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Avant de commencer, nous allons également réduire à 5m le far plane de nos caméras (Blender et Godot). La raison est simple, actuellement ils est réglé sur 100m, mais la géométrie de notre scène est concentré dans les 2 ou 3 première mètres. Si on ne fait rien, nos valeurs de profondeur seront compressées dans un fragment minuscule de l&rsquo;interval [near; far]. Ce qui rendrait les images illisible (et vous allez vois que même en faisant ça, il faudra parfois plisser un peu les yeux).</p>
<h3 id="1-channel-packing">1. Channel packing</h3>
<p>A ce stade nous n&rsquo;avons pas vraiment besoin de l&rsquo;oracle pour voir ce qui cloche avec nos textures :</p>
<ul>
<li>Blender duplique la valeur de depth dans tous les cannaux de l&rsquo;image. Ce qui donne cet aspect blanchatre à la texture déterministe</li>
<li>La hint_depth_texture dont est issue la texture intéractive n&rsquo;utilise quant à elle que le canal rouge pour encoder la depth. De plus, la valeur semble inversée (le 0 est loin de l&rsquo;écran, alors que le 1 est proche)</li>
</ul>
<p><a href="/projects/open_re_poc_devlog_2/images/white_det_vs_red_int.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/white_det_vs_red_int.opti.webp"></a></p>
<p>On va donc se servir de la fonction <code>pre_processd_d_depth</code> pour réorganiser tout ça :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_processd_d_depth</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_depth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">d_depth</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Après ce petit ajustement, voici à quoi ressemple notre première prophecie :</p>
<p><a href="/projects/open_re_poc_devlog_2/images/1_chan_diff.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/1_chan_diff.opti.webp"></a></p>
<p>Ca part de loin ! Mais pas de panique on va arranger ça.</p>
<h3 id="2-délinéarisation">2. Délinéarisation</h3>
<p>Comme l&rsquo;indique la documentation de Godot, la <code>hint_depth_texture</code> n&rsquo;est pas linéaire. C&rsquo;est tout à fait normal. Les défauts de rendu liés à la précision (notamment le Z-Fighting) sont toujours moins disgratieux en arrière plan que sous notre nez. C&rsquo;est pourquoi la matrice de projection déforme la dimention z des fragments de manière à &ldquo;donner du gras&rdquo; au valeurs proches.</p>
<p>La Mist que Blender, elle, est exportée par défaut est linéaire. Il existe un paramètre <code>Falloff</code> qui permet de changer ça :</p>
<img alt="Zoom sur le pattern" src="./images/mist_falloff.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>Malheureusement, il y a une infinité de façons de ne pas être linéaire et aucune des valeurs proposées par Blender ne semblait correspondre à la déformation appliquée par la matrice de projection côté Godot. Je suis donc parti de la definition de cette matrice (trouvable facilement sur internet) et j&rsquo;ai fait les calculs&hellip; Je vous fais grâçe de cette partie en intégrant directement le resultat dans la fonction <code>pre_processd_d_depth</code> (résultat que je n&rsquo;ai pas trouvé du premier coup je vous rassure).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">const</span> <span class="k">float</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">;</span>	<span class="c1">// near plane</span>
</span></span><span class="line"><span class="cl"><span class="k">const</span> <span class="k">float</span> <span class="n">f</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">;</span>	<span class="c1">// far plane</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_processd_d_depth</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_depth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">d_depth</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">unlinearized_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">f</span> <span class="o">-</span> <span class="n">n</span> <span class="o">*</span> <span class="n">f</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">unlinearized_depth</span> <span class="o">/=</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">unlinearized_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Après nouvelle solicitation de l&rsquo;oracle, on constate qu&rsquo;on est légèrement mieux mais c&rsquo;est pas encore ça.</p>
<p><a href="/projects/open_re_poc_devlog_2/images/2_chan_unlin_diff.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/2_chan_unlin_diff.opti.webp"></a></p>
<h3 id="3-use-hdr-2d">3. Use HDR 2D</h3>
<p>Je suis resté ploqué un moment à cette étape. Jusqu&rsquo;à ce que par hasard, je coche une case dans Godot qui allait résoudre tous mes problèmes. Cette case, c&rsquo;est <code>Use HDR 2D</code> dans la section <code>Rendering</code> de notre render target.</p>
<img alt="Zoom sur le pattern" src="./images/godot_use_hdr_2d.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>A ce moment là je n&rsquo;avais aucune idée de pourquoi c&rsquo;était mieux. Mais l&rsquo;oracle était claire&hellip; c&rsquo;était mieux ! (et ce malgré la présence d&rsquo;artefactes circulaires un peu étranges qu&rsquo;on ne manquera pas de noter)</p>
<p><a href="/projects/open_re_poc_devlog_2/images/3_chan_unlin_hdr_diff.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/3_chan_unlin_hdr_diff.opti.webp"></a></p>
<p>Après lecture de la description du paramètre (et pas mal d&rsquo;experimentations), je suis arrivé à la conclusion que les render target de Godot appliquent par defaut une correction gamma aux images qu&rsquo;elles produisent. Autrement dit, par defaut ces textures ne sont pas en Linear Color mais en sRGB.</p>
<p>Dans un shader, les calculs sont fait en Linear Color. La correction gamma n&rsquo;est appliquée qu&rsquo;en bout de chaine juste avant d&rsquo;afficher l&rsquo;image à l&rsquo;écran. C&rsquo;est pourquoi la depth déterministe de Blender est dans cet espace de couleur. Mais si l&rsquo;intéractive est en sRGB ça va pas du tout.</p>
<p>Il se trouve que la case <code>Use HDR 2D</code> permet entre autres d&rsquo;avoir une image en Linear Color sans correction gamma.</p>
<h3 id="4-mist-or-not-mist">4. Mist or not Mist</h3>
<p>Le nouveau présage est bien meilleur que les précédents, mais on va devoir se débarasser de ces vilains artefacts. Si on est attentif, on peut remarquer que les cercles sont de plus en plus claire à mesure que l&rsquo;on s&rsquo;éloigne du centre. C&rsquo;est cette observation qui m&rsquo;a permis de comprendre la différence entre la <code>Mist</code> et la <code>Z</code>.</p>
<p>La documentation ne l&rsquo;explique pas et je n&rsquo;ai pas lu le code source de Blender. Je ne suis donc sûr de rien, mais je pense que la <code>Mist</code> est la distance entre la caméra et le fragment, alors que la Z est le projeté orthogonal de la position du fragment sur l’axe Z de la caméra.</p>
<p><a href="/projects/open_re_poc_devlog_2/images/mist_vs_Z.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/mist_vs_Z.opti.webp"></a></p>
<p>Pour un fragment au centre de l&rsquo;écran, c&rsquo;est deux valeurs sont identiques. Mais plus on s&rsquo;éloigne du centre, plus elles divergent, ce qui explique parfaitement nos artefacts. On a choisit la <code>Mist</code> au doigt mouillé parce qu&rsquo;elle nous plaisait plus. Et ben perdu ! C&rsquo;était la <code>Z</code>&hellip;</p>
<p>Nous avons donc comis un petit délit de faciesse, mais en réalité, si la <code>Z</code> exportée était aussi moche, c’est parce que nous utilisons le format EXR. Dans ce format, les cannaux sont représentés par des floatants arbitraires (potentiellement même négatifs). Blender profite de cette propriété pour ecoder la profondeure exprimée directement en mètres. Par consequent tout ce qui est à plus d'1m de la caméra apparait completement blanc.</p>
<p>Il suffit de mapper la valeur de la depth entre le near plane (0.1m) et le far plane (5m) et le tour est joué. Notre <code>Z</code> retrouve son apparence originale.</p>
<p><a href="/projects/open_re_poc_devlog_2/images/compositor_map_Z.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/compositor_map_Z.opti.webp"></a></p>
<p>Un dernier passage chez l&rsquo;oracle nous confirme que c&rsquo;était bien cette passe qu&rsquo;il fallait utiliser. Les artefacts ont disparu et l&rsquo;image est prèsque totalement noir.</p>
<p><a href="/projects/open_re_poc_devlog_2/images/oracle_victory.opti.webp"><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_2/images/oracle_victory.opti.webp"></a></p>
<p>Seuls quelques minuscules point gris trahissent encore le contour du podium. Mais on peut s&rsquo;arreter là, ce résultat est plus que satisfaisant.</p>
<h2 id="iv-retour-sur-les-espaces-de-couleur">IV. Retour sur les espaces de couleur</h2>
<p>Petite parenthese pour discuter un point que j&rsquo;ai volontairement éludé et que vous avez peut être relevé. Pour que les texturent soient dans le même espace de couleur, nous avons du cocher la case <code>Use HDR 2D</code>. Mais alors pourquoi nous n&rsquo;avons pas eu à faire ça pour l&rsquo;albédo dans le numéro précédent ?</p>
<p>Je me suis égaleme posé cette question. Il s&rsquo;avère que la réponse est toute simple. Nous avions fait une autre erreur qui se compensait avec celle ci (décidément il bourde sur bourde celui là&hellip;). Si vous regardez bien les captures précédentes vous verez que le champs <code>color space</code> du noeud <code>File Output</code> est réglé sur <code>sRGB</code>.</p>
<img alt="Zoom sur le pattern" src="./images/blender_srgb.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>Comme évoqué précédament, les calculs doienvent être fait en Linear Color Space. Ce n&rsquo;est donc pas la bon espace pour notre texture d&rsquo;albédo déterministe. Mais comme la Render Target de la texture intéractive n&rsquo;avait pas <code>Use HDR 2D</code> de cochée, elle était aussi en sRGB. Les 2 textures étaient dans le même mauvais espace de couleur et dans ce cas, même l&rsquo;infini sagesse de l&rsquo;oracle ne peut rien pour nous.</p>
<p>On va donc cocher la <code>Use HDR 2D</code> de la render target de l&rsquo;albédo et dire à blender d&rsquo;exporter des textures en Linéaire pour corriger ça. Sauf qu&rsquo;on a le choix entre 6 espaces linéaires différents.</p>
<img alt="Zoom sur le pattern" src="./images/blender_linears.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>Après quelques essais, <code>Linear Rec.709</code> est visiblement l&rsquo;espace qu&rsquo;on cherche. Il donne un résultat aussi satisfaisant que le précédent (associé à la case magique bien entandu). On va donc partir là dessus jusqu&rsquo;à nouvel ordre. Mais il reste une dernière question : si l&rsquo;export Blender était réglé sur sRGB tout ce temps, comment se fait il, que la depth déterministe soit bien linéaire ?</p>
<p>Je pense que blender tiens compte du fait que les passes comme la <code>Mist</code> et la <code>Z</code> ne sont pas des images, mais des données mathématiques auquelles il n&rsquo;y a auccune raison d&rsquo;appliquer des changements d&rsquo;espace. Sur ces passes le champs <code>color space</code> semble inopérant. J&rsquo;ai tester d&rsquo;export de la <code>Z</code> en <code>sRGB</code> et en <code>Linear Rec.709</code>, les 2 images sont rigoureusement identiques.</p>
<h2 id="v-conclusion">V. Conclusion</h2>
<p>Comme vous le savez, les premier épisodes de cette serie sont écrit a-posteriori. Ce que je décris ici à en réalité été effectué il y a plusieurs mois. Repasser sur du travail déjà effectué est relativement fastidieux, mais je dois dire que cette seconde passe me permet d&rsquo;affiner ma compréhention des choses, d&rsquo;en découvrir de nouvelles voir même de corriger des erreures qui m&rsquo;avaient échapées.</p>
<p>Par exemple, l&rsquo;intégralité de l&rsquo;arc sur les espaces de couleur est nouveau. Au premier passage, je n&rsquo;avais pas vraiment questionné la case à coché magique. C&rsquo;était un réglage parmis 1000 autres sur lequel je n&rsquo;étais pas forcement revenu. Mais écrire ces article me force à trouver le sous-ensemble minimal de réglages qui donne le résultat attendu (parce que oui, je teste beaucoup plus de choses que ce que je présente). Et surtout, ça m&rsquo;oblige à réèlement comprendre pourquoi ça marche. Ce qui à beaucoup de valeur pour moi.</p>
<p>Le mois prochain, on s&rsquo;occupera de l&rsquo;harmonisation des normales. C&rsquo;est le dernier élement qui nous manque pour commencer à implémenter de la lumière. Après ça on va pouvoir faire des choses plus visuelles. J&rsquo;espère que ce nouveau numéro vous aura plu et je vous dis à bientôt pour de nouvelles aventures !</p>

            </div>
        </article>
<hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "turbo-tartine-games-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/J-Ponzo" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://jponzo.itch.io" target="_blank" rel="noopener noreferrer me"
    title="Itchio">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 245.371 220.736">
    <path
        d="M31.99 1.365C21.287 7.72.2 31.945 0 38.298v10.516C0 62.144 12.46 73.86 23.773 73.86c13.584 0 24.902-11.258 24.903-24.62 0 13.362 10.93 24.62 24.515 24.62 13.586 0 24.165-11.258 24.165-24.62 0 13.362 11.622 24.62 25.207 24.62h.246c13.586 0 25.208-11.258 25.208-24.62 0 13.362 10.58 24.62 24.164 24.62 13.585 0 24.515-11.258 24.515-24.62 0 13.362 11.32 24.62 24.903 24.62 11.313 0 23.773-11.714 23.773-25.046V38.298c-.2-6.354-21.287-30.58-31.988-36.933C180.118.197 157.056-.005 122.685 0c-34.37.003-81.228.54-90.697 1.365zm65.194 66.217a28.025 28.025 0 0 1-4.78 6.155c-5.128 5.014-12.157 8.122-19.906 8.122a28.482 28.482 0 0 1-19.948-8.126c-1.858-1.82-3.27-3.766-4.563-6.032l-.006.004c-1.292 2.27-3.092 4.215-4.954 6.037a28.5 28.5 0 0 1-19.948 8.12c-.934 0-1.906-.258-2.692-.528-1.092 11.372-1.553 22.24-1.716 30.164l-.002.045c-.02 4.024-.04 7.333-.06 11.93.21 23.86-2.363 77.334 10.52 90.473 19.964 4.655 56.7 6.775 93.555 6.788h.006c36.854-.013 73.59-2.133 93.554-6.788 12.883-13.14 10.31-66.614 10.52-90.474-.022-4.596-.04-7.905-.06-11.93l-.003-.045c-.162-7.926-.623-18.793-1.715-30.165-.786.27-1.757.528-2.692.528a28.5 28.5 0 0 1-19.948-8.12c-1.862-1.822-3.662-3.766-4.955-6.037l-.006-.004c-1.294 2.266-2.705 4.213-4.563 6.032a28.48 28.48 0 0 1-19.947 8.125c-7.748 0-14.778-3.11-19.906-8.123a28.025 28.025 0 0 1-4.78-6.155 27.99 27.99 0 0 1-4.736 6.155 28.49 28.49 0 0 1-19.95 8.124c-.27 0-.54-.012-.81-.02h-.007c-.27.008-.54.02-.813.02a28.49 28.49 0 0 1-19.95-8.123 27.992 27.992 0 0 1-4.736-6.155zm-20.486 26.49l-.002.01h.015c8.113.017 15.32 0 24.25 9.746 7.028-.737 14.372-1.105 21.722-1.094h.006c7.35-.01 14.694.357 21.723 1.094 8.93-9.747 16.137-9.73 24.25-9.746h.014l-.002-.01c3.833 0 19.166 0 29.85 30.007L210 165.244c8.504 30.624-2.723 31.373-16.727 31.4-20.768-.773-32.267-15.855-32.267-30.935-11.496 1.884-24.907 2.826-38.318 2.827h-.006c-13.412 0-26.823-.943-38.318-2.827 0 15.08-11.5 30.162-32.267 30.935-14.004-.027-25.23-.775-16.726-31.4L46.85 124.08C57.534 94.073 72.867 94.073 76.7 94.073zm45.985 23.582v.006c-.02.02-21.863 20.08-25.79 27.215l14.304-.573v12.474c0 .584 5.74.346 11.486.08h.006c5.744.266 11.485.504 11.485-.08v-12.474l14.304.573c-3.928-7.135-25.79-27.215-25.79-27.215v-.006l-.003.002z" />
</svg>
</a>
<a href="https://@turbotartine.bsky.social" target="_blank" rel="noopener noreferrer me"
    title="Bluesky">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
    d="M11.999,10.236c0.321,-0.524 0.916,-1.507 1.405,-2.376c0.755,-1.344 1.692,-2.852 2.869,-4.028c1.283,-1.281 2.845,-2.171 4.739,-2.171c1.144,-0 1.864,0.585 2.299,1.497c0.486,1.017 0.545,2.551 0.51,3.883c-0.051,1.945 -0.232,3.337 -0.505,4.275c-0.229,0.786 -0.543,1.303 -0.878,1.615c-0.892,0.833 -1.8,1.263 -2.634,1.484c0.029,0.018 0.056,0.036 0.084,0.055c0.528,0.367 0.823,0.79 1.081,1.107c0.648,0.794 0.644,1.795 0.23,2.784c-0.481,1.151 -1.533,2.279 -2.12,2.773c-1.389,1.171 -2.506,1.362 -3.383,1.133c-0.88,-0.23 -1.59,-0.932 -2.156,-1.826c-0.45,-0.71 -0.817,-1.537 -1.176,-2.186c-0.115,-0.208 -0.302,-0.455 -0.406,-0.587c-0.02,0.019 -0.04,0.04 -0.056,0.058c-0.121,0.145 -0.234,0.328 -0.349,0.531c-0.363,0.644 -0.721,1.463 -1.157,2.166c-0.555,0.895 -1.252,1.597 -2.12,1.825c-0.863,0.227 -1.97,0.037 -3.363,-1.136c-0.586,-0.494 -1.638,-1.622 -2.119,-2.773c-0.414,-0.989 -0.418,-1.99 0.229,-2.784c0.258,-0.317 0.554,-0.74 1.082,-1.106c0.027,-0.019 0.055,-0.038 0.084,-0.056c-0.834,-0.221 -1.742,-0.651 -2.634,-1.484c-0.335,-0.312 -0.649,-0.829 -0.878,-1.615c-0.273,-0.938 -0.454,-2.33 -0.505,-4.275c-0.036,-1.332 0.024,-2.866 0.509,-3.883c0.435,-0.912 1.156,-1.497 2.3,-1.497c2.32,0 4.109,1.203 5.494,2.808c1.272,1.474 2.195,3.283 2.9,4.643c0.231,0.447 0.436,0.84 0.624,1.146Zm-0.01,5.653l0.296,0.031l0.271,0.086c0.208,0.088 0.413,0.229 0.607,0.428c0.455,0.467 0.882,1.369 1.36,2.284c0.249,0.477 0.518,0.958 0.841,1.339c0.231,0.274 0.483,0.502 0.805,0.569c0.488,0.103 1.052,-0.157 1.811,-0.797c0.452,-0.38 1.274,-1.239 1.645,-2.126c0.155,-0.371 0.265,-0.75 0.022,-1.048c-0.179,-0.22 -0.366,-0.529 -0.732,-0.783c-0.536,-0.372 -1.356,-0.51 -1.905,-0.654c-0.405,-0.106 -0.715,-0.234 -0.88,-0.355l-0.284,-0.303l-0.135,-0.367l-0.008,-0.211l0.035,-0.196l0.078,-0.195l0.142,-0.209l0.198,-0.181l0.296,-0.154c0.151,-0.055 0.348,-0.092 0.587,-0.104c0.815,-0.042 2.571,0.294 4.235,-1.259c0.171,-0.159 0.288,-0.445 0.404,-0.845c0.246,-0.843 0.391,-2.096 0.438,-3.843c0.024,-0.91 0.026,-1.938 -0.208,-2.738c-0.142,-0.486 -0.367,-0.891 -0.896,-0.891c-1.675,0 -2.974,0.983 -4.031,2.21c-1.179,1.369 -2.058,3.057 -2.752,4.321c-0.483,0.88 -0.902,1.573 -1.25,1.916c-0.088,0.086 -0.174,0.157 -0.257,0.214l-0.221,0.125l-0.228,0.078l-0.267,0.031l-0.274,-0.034l-0.231,-0.083l-0.219,-0.132c-0.081,-0.058 -0.164,-0.131 -0.248,-0.22c-0.327,-0.343 -0.718,-1.037 -1.174,-1.917c-0.654,-1.262 -1.497,-2.948 -2.676,-4.314c-1.067,-1.236 -2.417,-2.217 -4.203,-2.217c-0.53,0 -0.754,0.405 -0.896,0.891c-0.234,0.8 -0.232,1.828 -0.208,2.738c0.046,1.747 0.192,3 0.438,3.843c0.116,0.4 0.233,0.686 0.403,0.845c1.665,1.553 3.421,1.217 4.235,1.259c0.24,0.012 0.437,0.049 0.588,0.104l0.295,0.154l0.199,0.181l0.142,0.209l0.078,0.195l0.035,0.196l-0.009,0.211l-0.135,0.368l-0.283,0.303c-0.165,0.12 -0.476,0.248 -0.88,0.355c-0.549,0.144 -1.369,0.281 -1.905,0.653c-0.366,0.254 -0.554,0.564 -0.732,0.783c-0.243,0.298 -0.133,0.677 0.022,1.048c0.371,0.887 1.193,1.746 1.645,2.127c0.757,0.637 1.311,0.9 1.789,0.8c0.311,-0.066 0.55,-0.29 0.772,-0.557c0.315,-0.381 0.577,-0.86 0.822,-1.337c0.394,-0.763 0.752,-1.521 1.138,-2.01c0.431,-0.544 0.929,-0.815 1.455,-0.815Z" style="fill-rule:nonzero;"/>
</svg>
</a>
<a href="https://mastodon.gamedev.place/@TurboTartine" target="_blank" rel="noopener noreferrer me"
    title="Mastodon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M21.58 13.913c-.29 1.469-2.592 3.121-5.238 3.396-1.379.184-2.737.368-4.185.276-2.368-.092-4.237-.551-4.237-.551 0 .184.014.459.043.643.308 2.294 2.317 2.478 4.22 2.57 1.922 0 3.633-.46 3.633-.46l.079 1.653s-1.344.734-3.738.918c-1.32.091-2.96-.092-4.869-.551-4.14-1.102-4.853-5.507-4.961-10.005-.034-1.285-.013-2.57-.013-3.58 0-4.589 3-5.966 3-5.966 1.513-.734 4.11-1.01 6.808-1.01h.067c2.699 0 5.296.276 6.81 1.01 0 0 3 1.377 3 5.967 0 0 .037 3.304-.419 5.69"
        stroke="currentColor" />
    <path
        d="M17.832 8.633v5h-1.978V8.78c0-1.023-.43-1.542-1.29-1.542-.95 0-1.427.616-1.427 1.834v2.655H11.17V9.072c0-1.218-.476-1.834-1.427-1.834-.86 0-1.29.52-1.29 1.542v4.852H6.475V8.633c0-1.022.26-1.834.782-2.434.538-.6 1.243-.909 2.118-.909 1.012 0 1.779.39 2.286 1.169l.492.827.493-.827c.507-.78 1.274-1.169 2.286-1.169.875 0 1.58.308 2.118.909.522.6.782 1.412.782 2.434"
        fill="currentColor" stroke="none" />
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 J-Ponzo(TurboTartine).
        Propulsé par <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Aller en haut" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
