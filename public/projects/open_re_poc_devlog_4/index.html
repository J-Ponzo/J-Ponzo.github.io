<!DOCTYPE html>
<html lang="fr-fr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">OpenRE devlog 4 : Fusion des mondes. Part I | Turbo Tartine Games</title>
<meta property="og:title" content="OpenRE devlog 4 : Fusion des mondes. Part I | Turbo Tartine Games" />
<meta name="twitter:title" content="OpenRE devlog 4 : Fusion des mondes. Part I | Turbo Tartine Games" />
<meta itemprop="name" content="OpenRE devlog 4 : Fusion des mondes. Part I | Turbo Tartine Games" />
<meta name="application-name" content="OpenRE devlog 4 : Fusion des mondes. Part I | Turbo Tartine Games" />
<meta property="og:site_name" content="Turbo Tartine Games" />

<meta name="description" content="devlog 4 du projet OpenRE">
<meta itemprop="description" content="devlog 4 du projet OpenRE" />
<meta property="og:description" content="devlog 4 du projet OpenRE" />
<meta name="twitter:description" content="devlog 4 du projet OpenRE" />

<meta property="og:locale" content="fr-fr" />
<meta name="language" content="fr-fr" />

  <link rel="alternate" hreflang="fr-fr" href="http://localhost:1313/projects/open_re_poc_devlog_4/" title="french" />






<meta name="generator" content="Hugo 0.137.0">

    
    <meta property="og:url" content="http://localhost:1313/projects/open_re_poc_devlog_4/">
  <meta property="og:site_name" content="Turbo Tartine Games">
  <meta property="og:title" content="OpenRE devlog 4 : Fusion des mondes. Part I">
  <meta property="og:description" content="devlog 4 du projet OpenRE">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-08-28T08:43:37+02:00">
    <meta property="article:modified_time" content="2025-08-28T08:43:37+02:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OpenRE devlog 4 : Fusion des mondes. Part I">
  <meta name="twitter:description" content="devlog 4 du projet OpenRE">


    

    <link rel="canonical" href="http://localhost:1313/projects/open_re_poc_devlog_4/">
    <link href="/style.min.108c4c461b7a4c182434be799ba3436432548ccab41bdb394e0779285f20212e.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
	
	
	<link rel="stylesheet" href="http://localhost:1313/css/togglecode.min.cb9bfee064f33d928a0183a1f9d86330cbadabb70a197c20e7265edad454eb3e.css">
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Accueil</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Accueil
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/projects/">
                        Projets
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Articles
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/glossary/">
                        Lexique
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        À propos
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">OpenRE devlog 4 : Fusion des mondes. Part I</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-08-28T08:43:37&#43;02:00" itemprop="datePublished"> 28 août 2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table des matières</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#i-introduction">I. Introduction</a></li>
    <li><a href="#ii-préparation-de-la-scène">II. Préparation de la scène</a></li>
    <li><a href="#iii-composition-de-la-géométrie">III. Composition de la géométrie</a>
      <ul>
        <li><a href="#1-définition-habituelle-dun-post-process">1. Définition habituelle d’un post-process</a></li>
        <li><a href="#2-inclusion-des-helpers-de-loracle">2. Inclusion des <em>helpers</em> de l’oracle</a></li>
        <li><a href="#3-parmètres-dentrée">3. Parmètres d&rsquo;entrée</a></li>
        <li><a href="#4-echantillonage-des-g-buffers">4. Echantillonage des G-Buffers</a></li>
        <li><a href="#5-selection-des-fragment">5. Selection des fragment</a></li>
        <li><a href="#6-affichage-du-fragment-final">6. Affichage du fragment final</a></li>
      </ul>
    </li>
    <li><a href="#iv-un-premier-modèle-dillumination">IV. Un premier modèle d’illumination</a>
      <ul>
        <li><a href="#1-inverse-square-law">1. Inverse Square Law</a></li>
        <li><a href="#2-implémentation">2. Implémentation</a>
          <ul>
            <li><a href="#11-paramètres-des-lumières">1.1. Paramètres des lumières</a></li>
            <li><a href="#12-calcul-de-la-position-du-fragment">1.2. Calcul de la position du fragment</a></li>
            <li><a href="#13-calcule-de-la-lumière">1.3. Calcule de la lumière</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#iv-conclusion">IV. Conclusion</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <p><a href="/projects/open_re_poc_devlog_3/">⬅️ Vers Précédent : &ldquo;OpenRE devlog 3 : Harmonisation des normales&rdquo;</a></p>
<h2 id="i-introduction">I. Introduction</h2>
<p>Grâce au travail effectué jusqu’ici, nous sommes en mesure de réaliser nos premiers rendus. Pour cela, nous allons partir de la scène actuelle, à laquelle nous ajouterons un peu de mouvement, mais surtout de la lumière.
Comme d’habitude, nous adopterons une approche itérative : nous commencerons par la version la plus rudimentaire possible, que nous complexifierons petit à petit jusqu’à atteindre notre objectif. À la fin, nous aurons un rendu en temps réel cohérent, comprenant :</p>
<ul>
<li>de la géométrie déterministe (pré-rendue dans Blender)</li>
<li>de la géométrie interactive (rendue en temps réel par Godot)</li>
<li>de la lumière déterministe (affectant aussi la géométrie interactive)</li>
<li>de la lumière interactive (affectant aussi la géométrie déterministe)</li>
</ul>
<p>Ou du moins, c’est ce que je prévoyais à l’origine. Mais je me suis rendu compte en cours de route que j’avais peut-être un peu sous-estimé le morceau. J&rsquo;ai donc décider de le traiter en 2 fois. Dans cette première partie, nous n&rsquo;aborderont pas la lumière déterministe, et seulement partiellement la lumière interactive. Mais ce n’est que partie remise, bien sûr.</p>
<h2 id="ii-préparation-de-la-scène">II. Préparation de la scène</h2>
<p>Jusqu&rsquo;ici, nous avons cherché à comparer des scènes identiques dans le but d&rsquo;étaloner Godot et Blender afin qu&rsquo;ils produisent des données bien harmonisées. Mais évidement dans un usage normal, le monde interactif diffère du déterministe. Dans Godot, nous allons donc masquer les éléments de la scène précédemment importée depuis Blender (qui sera notre scène déterministe).</p>
<img alt="Capture du dock scene de Godot dans lequel tous les [mesh](/pages/glossary/#mesh) issus de la simple-scene.blend ont été masqués" src="./images/hide_det_scn.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>On va ensuite ajouter de nouveaux meshes. Et comme ces meshes constituent le monde intéractif, on ne se privera pas de les animer.</p>
<p><a href="/projects/open_re_poc_devlog_4/images/int_geometry-anim.webp"><img alt="Gif de l&rsquo;editeur de godot montrant un agencement de primitives géométriques de couleurs unies qui tournent sure elle meme. Il y a un arceau qui ressemble à la porte des étoiles et un cube jaune au centre" src="/projects/open_re_poc_devlog_4/images/int_geometry-anim.webp"></a></p>
<p>Enfin, nous allons desactiver l’oracle et créer un nouveau <a href="/pages/glossary/#post-process">post-process</a> <code>ore_compositor</code> chargé de fusionner les deux scènes en temps réel. Comme l’oracle, il prendra en entrée les maps des G-Buffers déterministe et interactif, mais il aura également besoin de données supplémentaires relatives à la scène : les propriétés de la caméra active et, plus tard, celles des lumières.</p>
<img alt="Capture du dock Inspector de Godot dans lequel on peut voir les parametres du post-process ore_compositor" src="./images/ore_compositor.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>On oubliera pas de désactiver le post-process <a href="/pages/glossary/#quad">quad</a> de l’oracle et d’activer celui du compositor à la place.</p>
<img alt="Capture du dock scene de Godot dans lequel le post-process quad de l'oracle est masqué tandis que celui du ore_compositor est actif" src="./images/replace_oracle.opti.webp" style="display: block; margin-left: auto; margin-right: auto;" /> 
<p>Voyons à présent de quoi est fait ce post-process.</p>
<h2 id="iii-composition-de-la-géométrie">III. Composition de la géométrie</h2>
<p>Dans cette première itération, nous nous concentrons uniquement sur la géométrie, en laissant de côté la lumière. L’objectif est simple : obtenir un rendu <a href="/pages/glossary/#unlit"><em>unlit</em></a> où la scène interactive s’intègre naturellement à la scène déterministe, en respectant la profondeur.</p>
<p>Attention, pavé en approche ! Voici le code complet de cette première version du <a href="/pages/glossary/#shader">shader</a> :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Ne vous inquiétez pas, nous allons le disséquer ensemble dans les sections suivantes.</p>
<h3 id="1-définition-habituelle-dun-post-process">1. Définition habituelle d’un post-process</h3>
<p>Nous en avons déjà parlé : ces premières lignes sont identiques pour tous les post-process.</p>


  
  
  


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line hl"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line hl"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h3 id="2-inclusion-des-helpers-de-loracle">2. Inclusion des <em>helpers</em> de l’oracle</h3>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line hl"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Rappelez-vous : pour harmoniser les données, l’Oracle appliquait des prétraitements à certaines maps. J’ai extrait et regroupé ces fonctions dans le fichier <code>pre_process_utils.gdshaderinc</code>, que nous incluons ici. Ainsi, si nous modifions ces prétraitements, ils resteront valides pour les deux post-process. Voici son contenu :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="k">vec3</span> <span class="n">i_depth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">i_depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_depth</span><span class="p">,</span> <span class="k">float</span> <span class="n">near</span><span class="p">,</span> <span class="k">float</span> <span class="n">far</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">z</span> <span class="o">=</span> <span class="n">d_depth</span><span class="p">.</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="n">far</span> <span class="o">-</span> <span class="n">near</span><span class="p">)</span> <span class="o">+</span> <span class="n">near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">unlinearized_depth</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">far</span> <span class="o">-</span> <span class="n">near</span> <span class="o">*</span> <span class="n">far</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">far</span> <span class="o">-</span> <span class="n">near</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">unlinearized_depth</span> <span class="o">/=</span> <span class="n">z</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">unlinearized_depth</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">i_normal</span><span class="p">,</span> <span class="n">mat4</span> <span class="n">inv_view_matrix</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal</span> <span class="o">=</span> <span class="n">i_normal</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">inv_view_matrix</span> <span class="o">*</span> <span class="k">vec4</span><span class="p">(</span><span class="n">i_normal</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)).</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">i_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="k">vec3</span> <span class="n">d_normal</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="n">d_normal</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">d_normal</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="n">d_normal</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">d_normal</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h3 id="3-parmètres-dentrée">3. Parmètres d&rsquo;entrée</h3>
<p>Comme évoqué précédemment, le post-process prend en entrée des uniforms correspondant aux deux G-Buffers, ainsi que quelques paramètres supplémentaires relatifs à la scène.</p>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Pour l’instant, nous avons besoin :</p>
<ul>
<li>des paramètres <em>near</em> et <em>far</em> de la caméra active</li>
<li>des textures de <em>depth</em> et d’<em>albedo</em> issues des G-Buffers interactif et déterministe.</li>
</ul>
<p>L’albedo déterministe est ici nommé <code>d_diffuse_color_map</code>, car c’est son nom dans la terminologie Blender. Mais il s’agit bien de la même chose.</p>
<h3 id="4-echantillonage-des-g-buffers">4. Echantillonage des G-Buffers</h3>
<p>Chaque map est échantillonnée pour récupérer le fragment correspondant. Dans la foulée, nous appliquons les prétraitements.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h3 id="5-selection-des-fragment">5. Selection des fragment</h3>
<p>Ensuite, nous utilisons la profondeur pour déterminer lequel des deux mondes occlude l&rsquo;autre. Nous assignons alors les données correspondant au monde visible aux variables <code>depth_frag</code> et <code>albedo_frag</code>, que nous utiliserons dans la suite du shader.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="p">}</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h3 id="6-affichage-du-fragment-final">6. Affichage du fragment final</h3>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">albedo_frag</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Bon, d’accord, la &ldquo;suite du shader&rdquo; est pour l’instant un peu courte. Nous ne faisons qu’afficher directement l’albedo du monde sélectionné, sans même utiliser <code>depth_frag</code>. Mais ne vous inquiétez pas, ça viendra. Pour l’heure, je vous propose d’admirer ce magnifique chapaï !</p>

 

<video width="100%" controls muted loop playsinline autoplay>
    <source src="videos/unlit_chapai.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


<p>Oui, je sais, ce n’est pas très impressionnant sans lumière. Mais au moins, nous pouvons constater que la sélection du monde selon la profondeur est correcte : les parties du chapaï qui se trouvent sous le podium sont bien invisibles, tandis que le reste est correctement rendu par-dessus l’arrière-plan.</p>
<p>Mission accomplie ! Place à la lumière, maintenant.</p>
<h2 id="iv-un-premier-modèle-dillumination">IV. Un premier modèle d’illumination</h2>
<p>Avant de nous attaquer à un éclairage plus conventionnel, nous allons explorer un modèle d&rsquo;illumination pas du tout homologué basé uniquement sur l’atténuation de la lumière en fonction de la distance. Ce modèle ignore délibérément l’orientation des surfaces. Bien sûr, il n’est pas photoréaliste, mais il offre un rendu stylisé des plus intéressants.</p>
<p>Si vous voulez voir à quoi cela ressemble entre les mains d’une artiste compétente (ce que je ne suis pas vraiment), je vous conseille <a href="https://www.youtube.com/watch?v=RoqDqHdBI2Y">ce <em>talk</em></a> de Theresa Latzko. Elle y explique les choix artistiques et l’implémentation technique derrière la direction artistique de son jeu « Days of the Porcupine » (si vous vous demandez, oui, je lui ai complètement piqué l’idée, mouhahaha !).</p>
<p><a href="/projects/open_re_poc_devlog_4/images/days_of_porcupine.opti.webp"><img alt="Extrait de la présentation « Art of the Porcupine » par Theresa Latzko. A gauche un vertex lighting classic. A droite le fameux distance-only lighting" src="/projects/open_re_poc_devlog_4/images/days_of_porcupine.opti.webp"></a>
*Extrait de la présentation « Art of the Porcupine » par Theresa Latzko. A gauche un <a href="/pages/glossary/#vertex-lighting">vertex lighting</a> classic. A droite le fameux &ldquo;<em>distance-only lighting</em>&rdquo;</p>
<p>Nous n&rsquo;irons pas aussi loin qu&rsquo;elle car nous visons quelque chose de plutôt réaliste. Mais passer par cette étape intermédiaire nous permettra de nous étandre sur certains détails. Et on va commencer tout de suite par une petite parenthèse sur <em>l&rsquo;inverse square law</em>.</p>
<h3 id="1-inverse-square-law">1. Inverse Square Law</h3>
<p>La <em>inverse square law</em> est une loi physique qui s’applique à différentes quantités, dont l’intensité lumineuse irradiant d’une source ponctuelle. Elle dit que  &ldquo;l’intensité lumineuse en un point de l’espace est inversement proportionnelle au carré de la distance séparant ce point de la source&rdquo;. Ou de manière plus compacte : <code>I = I0 / d²</code> (avec <code>I0</code> l&rsquo;intensité de la source et <code>d</code> la distance)</p>
<p>Pour visualiser cette relation, imaginez une sphère centrée sur la source lumineuse. Les photons s’échappent de la source en ligne droite dans toutes les directions et entrent en collision avec la sphère. Ces collisions sont uniformément réparties sur toute sa surface.</p>
<p>Maintenant, imaginez que cette sphère grandisse. Le nombre de photons qui la frappent reste constant, car la quantité de lumière émise par la source ne dépend pas de la taille de la sphère. En revanche, la surface à éclairer augmente. La quantitée de lumière au m² est donc plus faible.</p>
<p><a href="/projects/open_re_poc_devlog_4/images/Inverse_square_law.opti.webp"><img alt="Illustration de l&rsquo;inverse square law" src="/projects/open_re_poc_devlog_4/images/Inverse_square_law.opti.webp"></a></p>
<p>Cette décroissance de la concentration de photons est directement liée à l’augmentation de la surface. Or, la surface d’une sphère est proportionnelle au carré de son rayon (<code>S = 4πr²</code>).</p>
<p>Si cette explication ne vous parle pas, pensez à un ballon de baudruche avec un motif imprimé dessus. En le gonflant, le motif s’étire et pâlit. C&rsquo;est un peu &ldquo;avec les mains&rdquo; comme exemple, mais ça illustre bien le principe : la quantité d’encre à la surface du ballon reste la même, mais elle se répartit sur une surface plus grande.</p>
<p>Bref, c&rsquo;est la loi qu&rsquo;on va utiliser pour modéliser notre lumière.</p>
<h3 id="2-implémentation">2. Implémentation</h3>
<p>Commençons par ajouter une OmniLight à la scène interactive. Un script la fera orbiter autour de notre structure, tout en altérant périodiquement sa couleur et son intensité. Une petite sphère blanche la matérialisera pour faciliter le débogage.</p>
<p><a href="/projects/open_re_poc_devlog_4/images/rotolight-anim.webp"><img alt="Gif de l&rsquo;editeur de godot montrant une light orbitant autours du chapaï" src="/projects/open_re_poc_devlog_4/images/rotolight-anim.webp"></a></p>
<p>Nous pouvons maintenant reprendre le shader pour y implémenter le fameux &ldquo;<em>distance-only lighting</em>&rdquo; de « Days of the Porcupine ». Pour un aperçu global, voici les modifications apportées :



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS CODE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line hl"><span class="cl">	<span class="p">}</span>
</span></span><span class="line hl"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Comme d’habitude, nous allons expliquer tout cela en douceur.</p>
<h4 id="11-paramètres-des-lumières">1.1. Paramètres des lumières</h4>
<p>D&rsquo;abord on fourni à notre post-process les paramètres de la lumière :</p>
<ul>
<li>position</li>
<li>couleur</li>
<li>intensité</li>
</ul>
<p>Bien qu’on en ait qu’une seule pour l’instant, nous anticipons dès maintenant l’ajout de nouvelles lumières en utilisant des tableaux plutôt que des variables simples.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<p><strong>Trois tableaux et un entier ? Pourquoi tant de haine ?!!</strong></p>
<p>&ldquo;Pourquoi ne pas utiliser un tableau de structures, comme dans n&rsquo;importe quel langage <a href="/pages/glossary/#cpu">CPU</a> ?&rdquo; Bonne question ! En GLSL, les tableaux sont très limités : leur taille doit être connue à la compilation, et en réalité, derière le rideau, ils sont souvent gérés comme une suite de variables simples. C’est plus une commodité d’écriture qu’une vrai structure de donnée.</p>
<p>La seule solution pour avoir des tableaux dynamiques, ce serait d’utiliser des SSBO (Shader Storage Buffer Objects). Sauf que… GDShader (le langage de shader de Godot) ne supporte ni les SSBO ni les structures. On est donc coincés avec trois tableaux de taille fixe et un entier pour savoir combien de lumières on a au total.</p>
<h4 id="12-calcul-de-la-position-du-fragment">1.2. Calcul de la position du fragment</h4>
<p>Pour calculer la distance entre la lumière et le fragment, il faut d’abord connaître sa position dans le monde. Et pour obtenir cette dernière, il faut comprendre ce que j’appelle la &ldquo;<em>coordinate transformation chain</em>&rdquo;.  Il s’agit de la succession de changements d’espaces qui font passer les <a href="/pages/glossary/#vertex">vertex</a> des coordonnées locales de l’objet à l’espace écran.</p>
<p><a href="/projects/open_re_poc_devlog_4/images/transform_chain.opti.webp"><img alt="Schéma décrivant la coordinate transformation chain changeant successivement d&rsquo;espace dans cet ordre : object space, world_space, view space, clip space, NDC space, screen space" src="/projects/open_re_poc_devlog_4/images/transform_chain.opti.webp"></a></p>
<p>Nous disposons déjà de la profondeur du fragment (<code>depth_frag</code>), et Godot nous fournit sa position à l’écran via la variable <code>SCREEN_UV</code>. Nous pouvons en déduire la coordonée en espace NDC (<em>Native Device Coordinate</em>).</p>
<p>À partir de là, il suffit d’inverser le tronçon de la &ldquo;<em>coordinate transformation chain</em>&rdquo; qui nous intéresse, et de l&rsquo;appliquer à notre <em>Native Device Coordinate</em> pour avoir la position du fragment en <em>world space</em> :</p>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<strong>Mais à quoi sert la ligne :</strong> <code>world.xyz /= world.w</code> <strong>?</strong></p>
<p>Vous n&rsquo;avez surement pas envie que je vous assome avec un cours sur les coordonnées homogènes. J&rsquo;avoue que ça tombe très bien car c&rsquo;est un sujet complexe que je ne maitrise pas totalement 😅 (ressources bienvenues dans les commentaires au passage !).</p>
<p>Pour faire simple, voici ce que je pense en avoir compris : l&rsquo;idée est de passer dans un espace de dimention supérieure qui offre des avantages mathématiques pratiques. En programmation graphique, cela permet notamment de :</p>
<ul>
<li>Faire la distinction entre une position et une direction</li>
<li>Modéliser la translation comme une multiplication matricielle</li>
<li>Avoir accès à la matrice de perspective</li>
</ul>
<p>C’est pour ces raisons que les API graphiques utilisent cet espace plutôt que l’espace euclidien classique. Pour convertir une coordonnée euclidienne en coordonnée homogène, on ajoute simplement une composante supplémentaire :</p>
<ul>
<li>1 pour une position : 	(x, y, z) =&gt; (x, y, z, 1)</li>
<li>0 pour une direction  : 	(x, y, z) =&gt; (x, y, z, 0)</li>
</ul>
<p>Pour revenir à une coordonnée euclidienne depuis une coordonnée homogène, on divise chaque composante par w : (x, y, z, w) =&gt; (x/w, y/w, z/w).</p>
<p>C’est de là que vient la ligne magique : <code>world.xyz /= world.w;</code>.</p>
<h4 id="13-calcule-de-la-lumière">1.3. Calcule de la lumière</h4>
<p>Pour déterminer la couleur finale du fragment, nous allons parcourir notre tableau de lumières et accumuler chacune de leurs contributions. Dans la plupart des modèles d’éclairage, chaque contribution se compose de deux parties :</p>
<ul>
<li>La diffuse : partie de la lumière dispersée dans toutes les directions, qui nous permet de percevoir la couleur de l’objet (comme une balle en caoutchouc).</li>
<li>La spéculaire : partie de la lumière réfléchie principalement dans une direction privilégiée produisant les reflets (par exemple, un mirroir est un objet completement spéculaire)</li>
</ul>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line hl"><span class="cl">	<span class="p">}</span>
</span></span><span class="line hl"><span class="cl">	
</span></span><span class="line hl"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Comme vous pouvez le constater, notre modèle du pauvre fait l&rsquo;impasse sur la spéculaire. La raison à cela, c&rsquo;est que nos G-Buffers actuels ne contiennent pas encore les données nécessaires pour calculer cette composante. Mais comme pour les tableaux de lumière, nous déclarons déjà <code>specular_contrib</code> en prévision des futures améliorations.</p>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Par ailleurs, vous pouvez remarquer que le facteur d’atténuation est bien calculé en appliquant l&rsquo;<em>inverse square law</em> :</p>
<p>


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

Ce qui nous donne le résultat suivant :</p>

 

<video width="100%" controls muted loop playsinline autoplay>
    <source src="videos/distance_only_light.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


<h2 id="iv-conclusion">IV. Conclusion</h2>
<p>Comme on a pu le voir en image, ce modèle d&rsquo;illumination marche très bien dans « Days of the Porcupine », mais il faut avouer que sur notre scène, il est un peu fade. Le rendu est très plat, et avec des couleurs pleines comme celles-ci, on a du mal à distinguer le relief.</p>
<p>Bien entendu, nous améliorerons cela dans la Partie II en implémentant un nouveau modèle un peu plus proche de notre objectif final. Nous ajouterons également de la lumière déterministe, préalablement rendue par Blender.</p>
<p>Une petite réflexion en passant ! Dans le précédent devlog, j’avais mentionné que nous aurions besoin des normales pour implémenter la lumière. Finalement, comme nous avons ignoré l’orientation des surfaces, elles ne se sont pas révélées nécessaires dans cette permière partie. Dommage, cela signifie que nous aurions pu aborder ce sujet un peu plus tôt dans la série.</p>
<p>À ma décharge, je n’avais pas prévu de couper ce numéro ici. La preuve que même en écrivant depuis le futur, on peut quand même arriver à se planter 😅.</p>

            </div>
        </article>
<hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "turbo-tartine-games-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/J-Ponzo" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://jponzo.itch.io" target="_blank" rel="noopener noreferrer me"
    title="Itchio">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 245.371 220.736">
    <path
        d="M31.99 1.365C21.287 7.72.2 31.945 0 38.298v10.516C0 62.144 12.46 73.86 23.773 73.86c13.584 0 24.902-11.258 24.903-24.62 0 13.362 10.93 24.62 24.515 24.62 13.586 0 24.165-11.258 24.165-24.62 0 13.362 11.622 24.62 25.207 24.62h.246c13.586 0 25.208-11.258 25.208-24.62 0 13.362 10.58 24.62 24.164 24.62 13.585 0 24.515-11.258 24.515-24.62 0 13.362 11.32 24.62 24.903 24.62 11.313 0 23.773-11.714 23.773-25.046V38.298c-.2-6.354-21.287-30.58-31.988-36.933C180.118.197 157.056-.005 122.685 0c-34.37.003-81.228.54-90.697 1.365zm65.194 66.217a28.025 28.025 0 0 1-4.78 6.155c-5.128 5.014-12.157 8.122-19.906 8.122a28.482 28.482 0 0 1-19.948-8.126c-1.858-1.82-3.27-3.766-4.563-6.032l-.006.004c-1.292 2.27-3.092 4.215-4.954 6.037a28.5 28.5 0 0 1-19.948 8.12c-.934 0-1.906-.258-2.692-.528-1.092 11.372-1.553 22.24-1.716 30.164l-.002.045c-.02 4.024-.04 7.333-.06 11.93.21 23.86-2.363 77.334 10.52 90.473 19.964 4.655 56.7 6.775 93.555 6.788h.006c36.854-.013 73.59-2.133 93.554-6.788 12.883-13.14 10.31-66.614 10.52-90.474-.022-4.596-.04-7.905-.06-11.93l-.003-.045c-.162-7.926-.623-18.793-1.715-30.165-.786.27-1.757.528-2.692.528a28.5 28.5 0 0 1-19.948-8.12c-1.862-1.822-3.662-3.766-4.955-6.037l-.006-.004c-1.294 2.266-2.705 4.213-4.563 6.032a28.48 28.48 0 0 1-19.947 8.125c-7.748 0-14.778-3.11-19.906-8.123a28.025 28.025 0 0 1-4.78-6.155 27.99 27.99 0 0 1-4.736 6.155 28.49 28.49 0 0 1-19.95 8.124c-.27 0-.54-.012-.81-.02h-.007c-.27.008-.54.02-.813.02a28.49 28.49 0 0 1-19.95-8.123 27.992 27.992 0 0 1-4.736-6.155zm-20.486 26.49l-.002.01h.015c8.113.017 15.32 0 24.25 9.746 7.028-.737 14.372-1.105 21.722-1.094h.006c7.35-.01 14.694.357 21.723 1.094 8.93-9.747 16.137-9.73 24.25-9.746h.014l-.002-.01c3.833 0 19.166 0 29.85 30.007L210 165.244c8.504 30.624-2.723 31.373-16.727 31.4-20.768-.773-32.267-15.855-32.267-30.935-11.496 1.884-24.907 2.826-38.318 2.827h-.006c-13.412 0-26.823-.943-38.318-2.827 0 15.08-11.5 30.162-32.267 30.935-14.004-.027-25.23-.775-16.726-31.4L46.85 124.08C57.534 94.073 72.867 94.073 76.7 94.073zm45.985 23.582v.006c-.02.02-21.863 20.08-25.79 27.215l14.304-.573v12.474c0 .584 5.74.346 11.486.08h.006c5.744.266 11.485.504 11.485-.08v-12.474l14.304.573c-3.928-7.135-25.79-27.215-25.79-27.215v-.006l-.003.002z" />
</svg>
</a>
<a href="https://@turbotartine.bsky.social" target="_blank" rel="noopener noreferrer me"
    title="Bluesky">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
    d="M11.999,10.236c0.321,-0.524 0.916,-1.507 1.405,-2.376c0.755,-1.344 1.692,-2.852 2.869,-4.028c1.283,-1.281 2.845,-2.171 4.739,-2.171c1.144,-0 1.864,0.585 2.299,1.497c0.486,1.017 0.545,2.551 0.51,3.883c-0.051,1.945 -0.232,3.337 -0.505,4.275c-0.229,0.786 -0.543,1.303 -0.878,1.615c-0.892,0.833 -1.8,1.263 -2.634,1.484c0.029,0.018 0.056,0.036 0.084,0.055c0.528,0.367 0.823,0.79 1.081,1.107c0.648,0.794 0.644,1.795 0.23,2.784c-0.481,1.151 -1.533,2.279 -2.12,2.773c-1.389,1.171 -2.506,1.362 -3.383,1.133c-0.88,-0.23 -1.59,-0.932 -2.156,-1.826c-0.45,-0.71 -0.817,-1.537 -1.176,-2.186c-0.115,-0.208 -0.302,-0.455 -0.406,-0.587c-0.02,0.019 -0.04,0.04 -0.056,0.058c-0.121,0.145 -0.234,0.328 -0.349,0.531c-0.363,0.644 -0.721,1.463 -1.157,2.166c-0.555,0.895 -1.252,1.597 -2.12,1.825c-0.863,0.227 -1.97,0.037 -3.363,-1.136c-0.586,-0.494 -1.638,-1.622 -2.119,-2.773c-0.414,-0.989 -0.418,-1.99 0.229,-2.784c0.258,-0.317 0.554,-0.74 1.082,-1.106c0.027,-0.019 0.055,-0.038 0.084,-0.056c-0.834,-0.221 -1.742,-0.651 -2.634,-1.484c-0.335,-0.312 -0.649,-0.829 -0.878,-1.615c-0.273,-0.938 -0.454,-2.33 -0.505,-4.275c-0.036,-1.332 0.024,-2.866 0.509,-3.883c0.435,-0.912 1.156,-1.497 2.3,-1.497c2.32,0 4.109,1.203 5.494,2.808c1.272,1.474 2.195,3.283 2.9,4.643c0.231,0.447 0.436,0.84 0.624,1.146Zm-0.01,5.653l0.296,0.031l0.271,0.086c0.208,0.088 0.413,0.229 0.607,0.428c0.455,0.467 0.882,1.369 1.36,2.284c0.249,0.477 0.518,0.958 0.841,1.339c0.231,0.274 0.483,0.502 0.805,0.569c0.488,0.103 1.052,-0.157 1.811,-0.797c0.452,-0.38 1.274,-1.239 1.645,-2.126c0.155,-0.371 0.265,-0.75 0.022,-1.048c-0.179,-0.22 -0.366,-0.529 -0.732,-0.783c-0.536,-0.372 -1.356,-0.51 -1.905,-0.654c-0.405,-0.106 -0.715,-0.234 -0.88,-0.355l-0.284,-0.303l-0.135,-0.367l-0.008,-0.211l0.035,-0.196l0.078,-0.195l0.142,-0.209l0.198,-0.181l0.296,-0.154c0.151,-0.055 0.348,-0.092 0.587,-0.104c0.815,-0.042 2.571,0.294 4.235,-1.259c0.171,-0.159 0.288,-0.445 0.404,-0.845c0.246,-0.843 0.391,-2.096 0.438,-3.843c0.024,-0.91 0.026,-1.938 -0.208,-2.738c-0.142,-0.486 -0.367,-0.891 -0.896,-0.891c-1.675,0 -2.974,0.983 -4.031,2.21c-1.179,1.369 -2.058,3.057 -2.752,4.321c-0.483,0.88 -0.902,1.573 -1.25,1.916c-0.088,0.086 -0.174,0.157 -0.257,0.214l-0.221,0.125l-0.228,0.078l-0.267,0.031l-0.274,-0.034l-0.231,-0.083l-0.219,-0.132c-0.081,-0.058 -0.164,-0.131 -0.248,-0.22c-0.327,-0.343 -0.718,-1.037 -1.174,-1.917c-0.654,-1.262 -1.497,-2.948 -2.676,-4.314c-1.067,-1.236 -2.417,-2.217 -4.203,-2.217c-0.53,0 -0.754,0.405 -0.896,0.891c-0.234,0.8 -0.232,1.828 -0.208,2.738c0.046,1.747 0.192,3 0.438,3.843c0.116,0.4 0.233,0.686 0.403,0.845c1.665,1.553 3.421,1.217 4.235,1.259c0.24,0.012 0.437,0.049 0.588,0.104l0.295,0.154l0.199,0.181l0.142,0.209l0.078,0.195l0.035,0.196l-0.009,0.211l-0.135,0.368l-0.283,0.303c-0.165,0.12 -0.476,0.248 -0.88,0.355c-0.549,0.144 -1.369,0.281 -1.905,0.653c-0.366,0.254 -0.554,0.564 -0.732,0.783c-0.243,0.298 -0.133,0.677 0.022,1.048c0.371,0.887 1.193,1.746 1.645,2.127c0.757,0.637 1.311,0.9 1.789,0.8c0.311,-0.066 0.55,-0.29 0.772,-0.557c0.315,-0.381 0.577,-0.86 0.822,-1.337c0.394,-0.763 0.752,-1.521 1.138,-2.01c0.431,-0.544 0.929,-0.815 1.455,-0.815Z" style="fill-rule:nonzero;"/>
</svg>
</a>
<a href="https://mastodon.gamedev.place/@TurboTartine" target="_blank" rel="noopener noreferrer me"
    title="Mastodon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M21.58 13.913c-.29 1.469-2.592 3.121-5.238 3.396-1.379.184-2.737.368-4.185.276-2.368-.092-4.237-.551-4.237-.551 0 .184.014.459.043.643.308 2.294 2.317 2.478 4.22 2.57 1.922 0 3.633-.46 3.633-.46l.079 1.653s-1.344.734-3.738.918c-1.32.091-2.96-.092-4.869-.551-4.14-1.102-4.853-5.507-4.961-10.005-.034-1.285-.013-2.57-.013-3.58 0-4.589 3-5.966 3-5.966 1.513-.734 4.11-1.01 6.808-1.01h.067c2.699 0 5.296.276 6.81 1.01 0 0 3 1.377 3 5.967 0 0 .037 3.304-.419 5.69"
        stroke="currentColor" />
    <path
        d="M17.832 8.633v5h-1.978V8.78c0-1.023-.43-1.542-1.29-1.542-.95 0-1.427.616-1.427 1.834v2.655H11.17V9.072c0-1.218-.476-1.834-1.427-1.834-.86 0-1.29.52-1.29 1.542v4.852H6.475V8.633c0-1.022.26-1.834.782-2.434.538-.6 1.243-.909 2.118-.909 1.012 0 1.779.39 2.286 1.169l.492.827.493-.827c.507-.78 1.274-1.169 2.286-1.169.875 0 1.58.308 2.118.909.522.6.782 1.412.782 2.434"
        fill="currentColor" stroke="none" />
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 J-Ponzo(TurboTartine).
        Propulsé par <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Aller en haut" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    


		<script src="http://localhost:1313/js/togglecode.min.20d8a7e249c5cfc719fa54b9545592036db0fee4e0ea851f283f820460c5b07b.js" defer></script>
    </body>
</html>
