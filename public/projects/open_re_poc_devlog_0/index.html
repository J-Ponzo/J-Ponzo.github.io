<!DOCTYPE html>
<html lang="fr-fr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">OpenRE devlog 0 : L&#39;Oracle | Turbo Tartine Games</title>
<meta property="og:title" content="OpenRE devlog 0 : L&#39;Oracle | Turbo Tartine Games" />
<meta name="twitter:title" content="OpenRE devlog 0 : L&#39;Oracle | Turbo Tartine Games" />
<meta itemprop="name" content="OpenRE devlog 0 : L&#39;Oracle | Turbo Tartine Games" />
<meta name="application-name" content="OpenRE devlog 0 : L&#39;Oracle | Turbo Tartine Games" />
<meta property="og:site_name" content="Turbo Tartine Games" />

<meta name="description" content="devlog 0 du projet OpenRE">
<meta itemprop="description" content="devlog 0 du projet OpenRE" />
<meta property="og:description" content="devlog 0 du projet OpenRE" />
<meta name="twitter:description" content="devlog 0 du projet OpenRE" />

<meta property="og:locale" content="fr-fr" />
<meta name="language" content="fr-fr" />

  <link rel="alternate" hreflang="fr-fr" href="http://localhost:1313/projects/open_re_poc_devlog_0/" title="french" />






<meta name="generator" content="Hugo 0.137.0">

    
    <meta property="og:url" content="http://localhost:1313/projects/open_re_poc_devlog_0/">
  <meta property="og:site_name" content="Turbo Tartine Games">
  <meta property="og:title" content="OpenRE devlog 0 : L&#39;Oracle">
  <meta property="og:description" content="devlog 0 du projet OpenRE">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-02-21T12:51:02+01:00">
    <meta property="article:modified_time" content="2025-02-21T12:51:02+01:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OpenRE devlog 0 : L&#39;Oracle">
  <meta name="twitter:description" content="devlog 0 du projet OpenRE">


    

    <link rel="canonical" href="http://localhost:1313/projects/open_re_poc_devlog_0/">
    <link href="/style.min.c8a4762fcc61b8002d9c11bb7081f1cea267d579ed5868f4b5e77f79358c57ee.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Accueil</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Accueil
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/projects/">
                        Projets
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Articles
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        À propos
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">OpenRE devlog 0 : L&#39;Oracle</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-02-21T12:51:02&#43;01:00" itemprop="datePublished"> 21 févr. 2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table des matières</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#introduction">Introduction</a></li>
    <li><a href="#shit-happens">Shit happens</a></li>
    <li><a href="#problématique-de-lharmonisation-des-données">Problématique de l&rsquo;harmonisation des données</a></li>
    <li><a href="#la-méthode-de-loracle">La méthode de l&rsquo;oracle</a>
      <ul>
        <li><a href="#implementation-de-loracle">Implementation de l’Oracle</a>
          <ul>
            <li><a href="#1-code-minimal-dun-post-process">1. Code minimal d&rsquo;un Post-Process</a></li>
            <li><a href="#2-les-uniforms-ou-paramettres-dentrée">2. Les uniforms ou paramettres d&rsquo;entrée</a></li>
            <li><a href="#3-utilitaires-de-sampling">3. Utilitaires de sampling</a></li>
            <li><a href="#4-implémentations-spécifiques-des-différences">4. Implémentations spécifiques des différences</a></li>
            <li><a href="#5-fragment--post-processmain">5. fragment() = post-process.main()</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#préparation-des-données">Préparation des données</a>
      <ul>
        <li><a href="#mise-en-place-dune-scène-test">Mise en place d’une scène test</a>
          <ul>
            <li><a href="#albedo-du-g-buffer-déterministe-">Albedo du G-Buffer déterministe :</a></li>
            <li><a href="#albedo-du-g-buffer-interactif-">Albedo du G-Buffer interactif :</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#harmonisation-de-lalbédo-">Harmonisation de l&rsquo;albédo :</a>
      <ul>
        <li>
          <ul>
            <li><a href="#espaces-colorimétriques-">Espaces colorimétriques :</a></li>
            <li><a href="#compression-de-texture-en-vram">Compression de texture en VRAM</a></li>
            <li><a href="#qualité-du-png-exporté">Qualité du png exporté</a></li>
            <li><a href="#le-format-exr-à-la-rescouse">Le format EXR à la rescouse</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#conclusion-">Conclusion :</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <h2 id="introduction">Introduction</h2>
<p>Bienvenu dans ce tout premier devlog d&rsquo;OpenRE : le develog Zéro ! Cette série a pour but de documenter la phase de POC (proof of concept) du projet. Le format sera assez simple. Tout au long du développement, je prendrai des notes dès que je tomberai sur un sujet intéressant. Chaque mois (si j’arrive à m’y tenir), je sélectionnerai les plus pertinents pour les présenter dans un nouveau numéro.</p>
<p>Étant donné qu’OpenRE est un projet personnel que je développe sur mon temps libre, le rythme de publication risque d’être irrégulier. Certains numéros seront plus légers que d’autres, mais ce n’est pas bien grave. Au contraire, ce sera intéressant de voir comment la cadence évolue au fil du temps.</p>
<p>Avant de démarer, je vous recommande de jeter un oeil à la <a href="/projects/open_re/">présentation générale du projet</a>. J&rsquo;y introduit notament quelques notions et un peu de terminologie. Il est préférable de l&rsquo;avoir parcouru pour contextualiser un peu ce dont je parle dans les devlogs.</p>
<p>Sur ce, c&rsquo;est parti !</p>
<h2 id="shit-happens">Shit happens</h2>
<p>Petite particularité concernant les première articles de la série : il s&rsquo;agira de &ldquo;retro-devlogs&rdquo;. En effet j’ai commencé OpenRE il y a plusieurs mois, sans trop savoir où j’allais. Je n&rsquo;étais pas sûr que mes expérimentations mèneraient quelque part et de toutes façons, l&rsquo;idée même de tenir un blog ne m&rsquo;avais pas encore traversé l&rsquo;esprit.</p>
<p>Durant cette période, il se trouve que le dépôt git a pris feu (suite à une sombre histoire fichiers blender beaucoup trop volumineux). Je sais qu&rsquo;il existe des methodes douce pour régler ce genre de problème. Mais j&rsquo;avoue que sur le moment je ne voyais pas trop l&rsquo;intérais. J&rsquo;ai donc bêtement supprimé le dépôt pour en recréer un avec ma copie locale (après avoir fait le nécessaire pour gérer un peu mieux mes scenes).</p>
<p>Résultat : j’ai perdu l’historique du projet. Je ne peux donc  plus réstaurer les premières versions pour analyser ce que j&rsquo;avais fait. Réaliser des capture d&rsquo;écran de mes résultats originaux est également impossible. Ces premiers numéros seront donc des reconstitutions.</p>
<h2 id="problématique-de-lharmonisation-des-données">Problématique de l&rsquo;harmonisation des données</h2>
<p>Si vous avez lu l&rsquo;article mentionné dans l&rsquo;introduction, vous savez qu&rsquo;OpenRE permet de fusionner le rendu de 2 scènes :</p>
<ul>
<li>La scène déterministe : précalculée dans Blender</li>
<li>La scène intéractive : rendue en temps réèl dans Godot.</li>
</ul>
<p>Pour cela, la technologie s&rsquo;appuie sur une structure de donnée particulière appelée un G-Buffer. Pour rappel, il s&rsquo;agit d&rsquo;une collections de textures encodant diverse données géométriques d&rsquo;une scène en espace écran. OpenRE fusionne le G-Buffer déterministe précalculé par Blender et le G-Buffer interactif rendu à la volée dans Godot. Mais il n&rsquo;est pas évident que des données produite par deux logiciels différents soitent directement compatibles. C&rsquo;est même pas gagné du tout en réalité.</p>
<p>En effet, tous les logiciels graphiques suivent des conventions qui leurs sont propres (unités, espaces colorimétriques, axes du repère &hellip;). Tant qu&rsquo;on reste à l&rsquo;interieur d&rsquo;un système, la cohérence de l&rsquo;ensemble est plus ou moins garantie. Mais dès lors que deux systèmes doivent s&rsquo;échanger des données pour collaborer, c&rsquo;est le début des problèmes.</p>
<p>Avant toute choses, il va donc falloir s&rsquo;arranger pour que Blender et Godot parlent la même langue. Et comme on va le voir, cela va demander un certain nombre d&rsquo;ajustements.</p>
<h2 id="la-méthode-de-loracle">La méthode de l&rsquo;oracle</h2>
<p>Pour identifier ces ajustements, je vais utiliser une technique que j’aime bien et que j’appelle le <em>Oracle Driven Development</em>. C’est un peu comme du <em>Test Driven Development</em>, sauf qu’au lieu d’avoir un jeu de tests automatisés, propre et exhaustif, je vais bricoler une petite moulinette qu’il faudra lancer à moitié à la main.</p>
<p>A la manière d&rsquo;un oracle, cette moulinette va formuler des prophéties parfois cryptiques en réponse aux questions qu&rsquo;on lui pose. Mais interprétées correctement, ces présages nous aideront à avancer dans notre périple.</p>
<p>Si Godot et Blender sont bien sur la même longueure d&rsquo;ondes, les G-Buffer qu&rsquo;ils produisent à partir d&rsquo;une même scène devraient être identiques. C&rsquo;est donc ce qu&rsquo;on va leur faire faire. Et le rôle de l&rsquo;oracle sera de prendre ces G-Buffers en entrée, et de nous fournir en réponse une image. Dans cette image on pourra lire 2 choses :</p>
<ul>
<li>les G-Buffer sont en parfaite harmonie -&gt; C&rsquo;est gagné, Godot et Blender sont en phase. On va pouvoir passer à la suite</li>
<li>les G-Buffer présentent des disonnances -&gt; Dans ce cas, il faudra analyser &ldquo;l&rsquo;image réponse&rdquo; pour essayer de déterminer l&rsquo;origine de la disonnance et essayer de la résoudre.</li>
</ul>
<p><img alt="Image illustrant le protocol de validation" src="/projects/open_re_poc_devlog_0/images/oracle_schema.opti.webp"></p>
<p>Mais trève de métaphore. Concrètement, cet Oracle est un post-process du nom de oracle.gdshader. Il prend en entrée les textures des deux G-Buffers et le type de texture à comparer. Son job est de calculer la différence entre les deux textures du type choisi (la déterministe et l’interactive) et de l&rsquo;afficher à l&rsquo;écran. Selon le type de donné, les différences pourron avoir des implémentations spécifiques. Mais chacune de ces implémentaions renveront une nuance de gris à interpréter comme suit :</p>
<ul>
<li>noir -&gt; les pixels sont identiques</li>
<li>blanc -&gt; la différence entre les pixels est maximale</li>
</ul>
<h3 id="implementation-de-loracle">Implementation de l’Oracle</h3>
<p>Voici le code source de l&rsquo;oracle :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Type de données à comparer</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">data_type</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// G-Buffer interactif</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_albedo</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_depth</span> <span class="o">:</span> <span class="n">hint_depth_texture</span><span class="p">,</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_normal</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_orm</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// G-Buffer déterministe</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_albedo</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_depth</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_normal</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_orm</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Récupère un pixel du G-Buffer déterministe selon le type spécifié</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">get_determinist_frag</span><span class="p">(</span><span class="k">int</span> <span class="n">tex_type</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">coord</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_albedo</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_depth</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_normal</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_orm</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Récupère un pixel du G-Buffer interactif selon le type spécifié</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">get_interactive_frag</span><span class="p">(</span><span class="k">int</span> <span class="n">tex_type</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">coord</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_albedo</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_depth</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_normal</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_orm</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">albedo_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">abs</span><span class="p">(</span><span class="n">determinist_frag</span> <span class="o">-</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Placeholder pour les autres types de différences</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">depth_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">normal_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">orm_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Le main du post process</span>
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">determinist_frag</span> <span class="o">=</span> <span class="n">get_determinist_frag</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">interactive_frag</span> <span class="o">=</span> <span class="n">get_interactive_frag</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">final_color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">albedo_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">depth_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">normal_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">orm_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">final_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>C&rsquo;est un petit pavé mais ne vous inquiétez on va le décortiquer ensemble.</p>
<h4 id="1-code-minimal-dun-post-process">1. Code minimal d&rsquo;un Post-Process</h4>
<p>D&rsquo;abord on a quelques lignes sur lesquelles on ne s&rsquo;attardera pas. C&rsquo;est le code usuel pour créer un post-process dans Godot.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="2-les-uniforms-ou-paramettres-dentrée">2. Les uniforms ou paramettres d&rsquo;entrée</h4>
<p>Ensuite on a les uniforms qui sont les paramettres d&rsquo;entrée d&rsquo;un shader. C&rsquo;est à travers un uniform que le code CPU peut envoyer de la donné au GPU. Une fois valués, ils peuveut être référencés dans le code du shader un peu comme une variable globale. Comme évoqué précédement ces uniform correspondent aux textures des deux G-Buffers (de la forme <code>sampler2D [i|d]gbuffer_&lt;type&gt;</code>) et au type selectionné pour la comparaison (<code>int data_type</code>)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Type de données à comparer</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">data_type</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// G-Buffer interactif</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_albedo</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_depth</span> <span class="o">:</span> <span class="n">hint_depth_texture</span><span class="p">,</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_normal</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">igbuffer_orm</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// G-Buffer déterministe</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_albedo</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_depth</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_normal</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">dgbuffer_orm</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="3-utilitaires-de-sampling">3. Utilitaires de sampling</h4>
<p>Les 2 blocs suivants sont des helpers qui permettent de sampler la texture demandé dans les G-Buffers :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Récupère un pixel du G-Buffer déterministe selon le type spécifié</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">get_determinist_frag</span><span class="p">(</span><span class="k">int</span> <span class="n">tex_type</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">coord</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_albedo</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_depth</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_normal</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">dgbuffer_orm</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Récupère un pixel du G-Buffer interactif selon le type spécifié</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">get_interactive_frag</span><span class="p">(</span><span class="k">int</span> <span class="n">tex_type</span><span class="p">,</span> <span class="k">vec2</span> <span class="n">coord</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_albedo</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_depth</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_normal</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tex_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="k">return</span> <span class="n">texture</span><span class="p">(</span><span class="n">igbuffer_orm</span><span class="p">,</span> <span class="n">coord</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="4-implémentations-spécifiques-des-différences">4. Implémentations spécifiques des différences</h4>
<p>S&rsquo;en suivent les implémentations de la différence pour chaque type de donnée. Vous remarquerez qu&rsquo;à part <code>vec3 albedo_difference(...)</code>, tout le monde renvois la couleur blanche. Voyez ça comme le <code>return null;</code> ou le <code>throw Exception();</code> qu&rsquo;on met par defaut quand on prévois d’implémenter une fonction plus tard.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Calcul de la différence entre les textures d&#39;albedo</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">albedo_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="n">abs</span><span class="p">(</span><span class="n">determinist_frag</span> <span class="o">-</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Placeholder pour les autres types de différences</span>
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">depth_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">normal_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">vec3</span> <span class="n">orm_difference</span><span class="p">(</span><span class="k">vec3</span> <span class="n">determinist_frag</span><span class="p">,</span> <span class="k">vec3</span> <span class="n">interactive_frag</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="5-fragment--post-processmain">5. fragment() = post-process.main()</h4>
<p>Et enfin il y a la fonction <code>void fragment()</code> qui est l&rsquo;équivalent du <code>main()</code> pour un post process. On vois qu&rsquo;elle utilise les helpers pour récupérer les pixels deterministes et interactifs en fonction du type de donnée selectionné. Puis elle calcule et affiche la difference entre ces deux pixels (selon l&rsquo;implementation elle aussi designée par le type).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// Le main du post process</span>
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">determinist_frag</span> <span class="o">=</span> <span class="n">get_determinist_frag</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">interactive_frag</span> <span class="o">=</span> <span class="n">get_interactive_frag</span><span class="p">(</span><span class="n">data_type</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">final_color</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mo">0</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">albedo_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">depth_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">normal_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">data_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="n">final_color</span> <span class="o">=</span> <span class="n">orm_difference</span><span class="p">(</span><span class="n">determinist_frag</span><span class="p">,</span> <span class="n">interactive_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">final_color</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="préparation-des-données">Préparation des données</h2>
<p>Nous savons desormais comment fonctionne l&rsquo;oracle. Mais nous n&rsquo;avons pas de données à lui soumettre. Il faut les construire.</p>
<h3 id="mise-en-place-dune-scène-test">Mise en place d’une scène test</h3>
<p>Pour commencer, j’ai créé une petite scène dans Blender. Elle est composée de quelques primitives basiques et d’une caméra. Ensuite, je l’ai reproduite à l’identique dans Godot. L’opération est triviale, puisque Godot prend en charge le format de scène Blender : il suffit d’importer le fichier <code>.blend</code> et de l’ajouter dans une scène vide.</p>
<p><img alt="Illustration représentant la SimpleScene dans Blender" src="/projects/open_re_poc_devlog_0/images/simpleBlend.opti.webp"><br>
<img alt="Illustration représentant la SimpleScene dans Godot" src="/projects/open_re_poc_devlog_0/images/simpleGodot.opti.webp"></p>
<p>Vous l&rsquo;aurez compris, c&rsquo;est de cette scène que seront issus les G-Buffers déterministes et interaxctifs que nous allons soumettre à l&rsquo;oracle. À terme, ces G-Buffers devront contenir les textures suivantes :</p>
<ul>
<li><strong>Albedo</strong> (couleur diffuse)</li>
<li><strong>Depth</strong> (profondeur)</li>
<li><strong>Normal</strong> (orientation des surfaces)</li>
<li><strong>ORM</strong> (Occlusion, Roughness, Metallic)</li>
</ul>
<p>Mais pour commencer, on va se concentrer sur l’Albedo. Croyez-moi, c’est bien suffisant pour aujourd’hui ! On traitera les autres types de données dans des devlogs dédiés.</p>
<h4 id="albedo-du-g-buffer-déterministe-">Albedo du G-Buffer déterministe :</h4>
<p>Pour générer la texture d&rsquo;Albedo déterministe dans Blender, on va activer la <code>diffCol pass</code> de Cycles (qui correspon à l&rsquo;Albedo) puis on va effectuer un rendu. Grâce au compositor et au noeud <code>File Output</code>, l&rsquo;image correspondant à cette passe sera automatiquement exportée à l&rsquo;emplacement spécifié à la fin du rendu. Il n&rsquo;y aura plus qu&rsquo;à importer cette image dans Godot et à la binder au <code>uniform dgbuffer_albedo</code> de l&rsquo;oracle.</p>
<p>[Compo =&gt; image =&gt; import =&gt; bind]</p>
<h4 id="albedo-du-g-buffer-interactif-">Albedo du G-Buffer interactif :</h4>
<p>Pour la version interactive c&rsquo;est un peu plus complexe. Le shading language de Godot permet d&rsquo;injecter cetraines textures dans un uniform que l&rsquo;on peut ensuite utiliser à souhait dans notre shader. La syntaxe est la suivante :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">texture</span> <span class="o">:</span> <span class="n">hint_</span><span class="o">&lt;</span><span class="n">insert_texture_name</span><span class="o">&gt;</span><span class="n">_texture</span><span class="p">;</span>
</span></span></code></pre></div><p>La texture qui nous interesse ici est <code>hint_screen_texture</code>. Mais malheureusement il ne s&rsquo;agit pas directement de l&rsquo;albedo. C&rsquo;est un rendu classic depuis la caméra prenant en compte la lumière. On va donc tricher un peu en utilisant une render target (un <code>SubViewport en terminologie Godot</code>) dont on va régler le parametre <code>Debug Draw</code> sur <code>Unshaded</code>. Il suffit ensuite de binder cette render target au <code>uniform igbuffer_albedo</code> de l&rsquo;oracle.</p>
<h2 id="harmonisation-de-lalbédo-">Harmonisation de l&rsquo;albédo :</h2>
<p>Nous avons correctement créé et bindé nos textures d&rsquo;albedo. Ces données en été obtenues à partir de 2 scenes rigoureusement identiques puisqu&rsquo;elles viennent du même fichier. Donc si l&rsquo;importer de Godot est bien capable de traduire les données de Blender pour les conformer à ses propres conventions, nous devrions obtenir un prophécie encourageante (un écran noir). Qu&rsquo;est-ce qui pourait mal se passer ?</p>
<p><img alt="Capture de la première prophétie de l&rsquo;Oracle" src="/projects/open_re_poc_devlog_0/images/first_prophecy.opti.webp">
<em>Oh noooooo !</em></p>
<p>Rassurez vous l&rsquo;importer de Godot fonctionne très bien, le problème n&rsquo;est pas là. Comme c&rsquo;est très souvent le cas, la plupart des problème ont été indroduit par la seule étape manuelle de la moulinette : l&rsquo;export/import de la texture déterministe.</p>
<h4 id="espaces-colorimétriques-">Espaces colorimétriques :</h4>
<p>Si on observe les textures d&rsquo;albedo que l&rsquo;oracle à comparé, le première problème qui saute aux yeux c&rsquo;est que la texture déterministe apparait une peu &ldquo;délavée&rdquo; par rapport à l&rsquo;autre.</p>
<p><img alt="gif alternant l&rsquo;albedo interactif et l&rsquo;aldedo deterministe délavé" src="/projects/open_re_poc_devlog_0/images/init_input_alterance.webp"></p>
<p>Il s&rsquo;agit d&rsquo;un problème d&rsquo;export. J&rsquo;avais bien en tête qu&rsquo;il s&rsquo;agissait surement d&rsquo;une histoire d&rsquo;espace de couleur. Mais Blender porpose un (très, très, très) vaste panel d&rsquo;options d&rsquo;export. Trop pour qu&rsquo;un individu lambda comme moi puisse tout comprendre. J&rsquo;ai donc expérimenté beaucoup de choses un peu à l&rsquo;instinct jusqu&rsquo;à trouver le parametre qui m&rsquo;interesse.</p>
<p>Il fallait régler champs <code>view</code> de l&rsquo;export png sur <code>Standard</code> :</p>
<p><img alt="gif montrant comment mettre le champs view de l&rsquo;export png sur standard" src="/projects/open_re_poc_devlog_0/images/set_standar_view.gif"></p>
<p>On peut ensuitre relancer un rendu et donner notre nouvelles texture à l&rsquo;oracle pour un revision de la prophetie. Et on obtien ça (ce qui est déjà beaucoup mieux.) :</p>
<p><img alt="Capture de la première prophétie de l&rsquo;Oracle" src="/projects/open_re_poc_devlog_0/images/first_prophecy_revision_1.opti.webp"></p>
<h4 id="compression-de-texture-en-vram">Compression de texture en VRAM</h4>
<p>Beaucoup mieux certes, pais pas encore gagné. Continuons ! Si on zoom sur l&rsquo;image de la prophecie révisée, on peu voire apparetre des petits motifs caracteristiques.</p>
<p><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_0/images/1_std_dist_zoom.opti.webp"></p>
<p>Il s&rsquo;agit d&rsquo;artefacts de compression. En effet pour économiser la mémoire vidéo et optimiser les echange de données entre le CPU et le GPU, les textures utilisée dans un jeu sont prèsque toujours compréssée. Il est donc normal que le parametre d&rsquo;import de Godot soient réglés sur <code>Compress Mode = VRAM Compressed</code>.</p>
<p>Le problème c&rsquo;est que les algorythmes de compression utilisés par les moteurs ne sont pas vraiment fait pour notre cas d&rsquo;useage. En effet, la vocation d&rsquo;une textures la plupart du temps est d&rsquo;habiller les meshes qui composent la scène, pas de représenter un scène compète affichée en plein écran comme on le fait ici.</p>
<p>Si on compare l&rsquo;image source à sa version compressée on voit clairement la perte de qualité.</p>
<p><img alt="gif alternant l&rsquo;image source et sa version compressée" src="/projects/open_re_poc_devlog_0/images/alternate_vram_compression.webp"></p>
<p>Pour régler ça il suffit de desactiver la compression dans les paramettres d&rsquo;import de la texture :</p>
<p><img alt="gif indiquant comment desactiver la compression des textures dans Godot" src="/projects/open_re_poc_devlog_0/images/set_lossless-optimize.gif"></p>
<p>Et voici nouvelle réponse de l&rsquo;oracle quand la texture n&rsquo;est pas compressée (les plaisenteries les plus courtes étant les meilleures, je vous fais grâce de mon petit montage à partir d&rsquo;ici).</p>
<p><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_0/images/2_lossless_detrminist_zoom.opti.webp"></p>
<h4 id="qualité-du-png-exporté">Qualité du png exporté</h4>
<p>On a déjà pas mal gagné mais l&rsquo;image est toujours un peu bruitée. Le lecteur attentif aura surement remarqué le champs <code>compression = 15%</code> de l&rsquo;export png quand nous avons régler l&rsquo;espace de couleur au début. J&rsquo;ai effetivement essayé de le mettre à 0, mais ça n&rsquo;a rien changé. J&rsquo;ai donc essayé d&rsquo;augmenter la qualité du png en montant la <code>Color Depth</code> à 16 bit. Et là : Victoire ! La compression à totalement disparue. Mais maintenant on peut voire qu&rsquo;il y a de gros problèmes de banding. Ce qui est pire&hellip;</p>
<p><img alt="Zoom sur le pattern" src="/projects/open_re_poc_devlog_0/images/3_png_c0_Distance_ohnooo.opti.webp"></p>
<p>En effet la documentaion de Godot nous informe que l&rsquo;import png est limité à 8 bits. Je présume que la couleur de notre image 16 bits est clampée à l&rsquo;import, ce qui produit les bandes. C&rsquo;est l&rsquo;impasse, il va falloir trouver autre chose.</p>
<h4 id="le-format-exr-à-la-rescouse">Le format EXR à la rescouse</h4>
<p>A patire de là, j&rsquo;ai éteint mon cerveau et j&rsquo;ai commencé à &ldquo;brute force&rdquo; les paramètre d&rsquo;export de blender à la recherche du meilleur alignement de planète. C&rsquo;était pas vraiment l&rsquo;autoroute du fun. Je dramatise peut-être un peu, mais dans mon souvenir ça a pris des jours. Des jours à itérer sur les paramêtres, faire des rendu, donner les texture à manger à l&rsquo;oracle et scruter les retours essayant de déterminer en quoi c&rsquo;était mieux ou pire que telle ou telle autre réglage. Le meilleur compromis auquel j&rsquo;ai pu arriver est le suivant :</p>
<p><img alt="Reglage de l&rsquo;export exr dans blender" src="/projects/open_re_poc_devlog_0/images/set_exr_half.opti.webp"></p>
<p>Je ne connaissais pas le formats .exr. Pour la petite histoire, il aurait été créé par <em>Industrial Light &amp; Magic</em> : la société d&rsquo;effets spéciaux de <em>George Lucas</em>. Les valeurs <code>float (half)</code> et <code>float (full)</code> du champs <code>Color Depth</code> donnent des resultats légèrement différent, mais je n&rsquo;ai pas été capable de determiner lequel était mieux. En revanche la texture en <code>float (full)</code> pèse 7.13 MB alors que l&rsquo;autre atteint à peine les 250 KB. J&rsquo;ai donc choisi de réster en half (pour le moment).</p>
<p>Malheureusement le resultat n&rsquo;est pas encore parfait, mais c&rsquo;est le mieux que j&rsquo;ai pu faire. Si vous avez une idée de comment l&rsquo;améliorer : je prends ! Cela dit il faut aussi relativiser. Lorsque on compare les texture d&rsquo;albedo deterministes et interactives actuelles, il est très difficile de trouver des différences.</p>
<p><img alt="alterance textures finales" src="/projects/open_re_poc_devlog_0/images/gifalt_final_textures.webp"></p>
<p>La seule chose que mon oeil arrive à percevoir, c&rsquo;est un peu d&rsquo;aliasing au niveau des contours (n&rsquo;hesitez pas à me dire en commentaire si vous voyez autre chose). Depuis le début les coutours sont en effet très prohiminents. Cela vient du fait que la texture deterministe raytracée par cycle n&rsquo;est pas aliasée, alors que la version interactive générée par rasterisation dans Godot l&rsquo;est. On peut donc encore gagner un peu en activant l&rsquo;aliasing sur la render target.</p>
<p><img alt="Retrospective des différentes étapes" src="/projects/open_re_poc_devlog_0/images/gif_alt_goodenough.webp">
<em>Désolé. J&rsquo;ai pas resisté&hellip; ^^</em></p>
<p>S&rsquo;il s&rsquo;agissait d&rsquo;un autre type de donnée je serais plus inquiet. Mais pour de l&rsquo;albedo (qui est basiquement la couleur des surface), le &ldquo;jugé à l&rsquo;oeil&rdquo; ne me parait pas bien dangeureux. Si plus tard dans le developpement on a des problèmes de rendu, ce sera le moment de se rappeller qu&rsquo;on a une source d&rsquo;erreur potentielle ici. Mais pour le POC, on va va dire que c&rsquo;est &ldquo;good enough&rdquo;.</p>
<h2 id="conclusion-">Conclusion :</h2>
<ul>
<li>Dire qu&rsquo;il faudra plus de scènes pour être sûr</li>
<li>C&rsquo;était tr-s long ! Ne perdez pas votre historique ! Vraiment !</li>
</ul>

            </div>
        </article>
<hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "turbo-tartine-games-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/J-Ponzo" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://jponzo.itch.io" target="_blank" rel="noopener noreferrer me"
    title="Itchio">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 245.371 220.736">
    <path
        d="M31.99 1.365C21.287 7.72.2 31.945 0 38.298v10.516C0 62.144 12.46 73.86 23.773 73.86c13.584 0 24.902-11.258 24.903-24.62 0 13.362 10.93 24.62 24.515 24.62 13.586 0 24.165-11.258 24.165-24.62 0 13.362 11.622 24.62 25.207 24.62h.246c13.586 0 25.208-11.258 25.208-24.62 0 13.362 10.58 24.62 24.164 24.62 13.585 0 24.515-11.258 24.515-24.62 0 13.362 11.32 24.62 24.903 24.62 11.313 0 23.773-11.714 23.773-25.046V38.298c-.2-6.354-21.287-30.58-31.988-36.933C180.118.197 157.056-.005 122.685 0c-34.37.003-81.228.54-90.697 1.365zm65.194 66.217a28.025 28.025 0 0 1-4.78 6.155c-5.128 5.014-12.157 8.122-19.906 8.122a28.482 28.482 0 0 1-19.948-8.126c-1.858-1.82-3.27-3.766-4.563-6.032l-.006.004c-1.292 2.27-3.092 4.215-4.954 6.037a28.5 28.5 0 0 1-19.948 8.12c-.934 0-1.906-.258-2.692-.528-1.092 11.372-1.553 22.24-1.716 30.164l-.002.045c-.02 4.024-.04 7.333-.06 11.93.21 23.86-2.363 77.334 10.52 90.473 19.964 4.655 56.7 6.775 93.555 6.788h.006c36.854-.013 73.59-2.133 93.554-6.788 12.883-13.14 10.31-66.614 10.52-90.474-.022-4.596-.04-7.905-.06-11.93l-.003-.045c-.162-7.926-.623-18.793-1.715-30.165-.786.27-1.757.528-2.692.528a28.5 28.5 0 0 1-19.948-8.12c-1.862-1.822-3.662-3.766-4.955-6.037l-.006-.004c-1.294 2.266-2.705 4.213-4.563 6.032a28.48 28.48 0 0 1-19.947 8.125c-7.748 0-14.778-3.11-19.906-8.123a28.025 28.025 0 0 1-4.78-6.155 27.99 27.99 0 0 1-4.736 6.155 28.49 28.49 0 0 1-19.95 8.124c-.27 0-.54-.012-.81-.02h-.007c-.27.008-.54.02-.813.02a28.49 28.49 0 0 1-19.95-8.123 27.992 27.992 0 0 1-4.736-6.155zm-20.486 26.49l-.002.01h.015c8.113.017 15.32 0 24.25 9.746 7.028-.737 14.372-1.105 21.722-1.094h.006c7.35-.01 14.694.357 21.723 1.094 8.93-9.747 16.137-9.73 24.25-9.746h.014l-.002-.01c3.833 0 19.166 0 29.85 30.007L210 165.244c8.504 30.624-2.723 31.373-16.727 31.4-20.768-.773-32.267-15.855-32.267-30.935-11.496 1.884-24.907 2.826-38.318 2.827h-.006c-13.412 0-26.823-.943-38.318-2.827 0 15.08-11.5 30.162-32.267 30.935-14.004-.027-25.23-.775-16.726-31.4L46.85 124.08C57.534 94.073 72.867 94.073 76.7 94.073zm45.985 23.582v.006c-.02.02-21.863 20.08-25.79 27.215l14.304-.573v12.474c0 .584 5.74.346 11.486.08h.006c5.744.266 11.485.504 11.485-.08v-12.474l14.304.573c-3.928-7.135-25.79-27.215-25.79-27.215v-.006l-.003.002z" />
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 J-Ponzo(TurboTartine).
        Propulsé par <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Aller en haut" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    

</body>
</html>
