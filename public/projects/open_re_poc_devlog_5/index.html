<!DOCTYPE html>
<html lang="fr-fr"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="content-type" content="text/html">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title itemprop="name">OpenRE devlog 5 : Fusion des mondes. Part II | Turbo Tartine Games</title>
<meta property="og:title" content="OpenRE devlog 5 : Fusion des mondes. Part II | Turbo Tartine Games" />
<meta name="twitter:title" content="OpenRE devlog 5 : Fusion des mondes. Part II | Turbo Tartine Games" />
<meta itemprop="name" content="OpenRE devlog 5 : Fusion des mondes. Part II | Turbo Tartine Games" />
<meta name="application-name" content="OpenRE devlog 5 : Fusion des mondes. Part II | Turbo Tartine Games" />
<meta property="og:site_name" content="Turbo Tartine Games" />

<meta name="description" content="devlog 5 du projet OpenRE">
<meta itemprop="description" content="devlog 5 du projet OpenRE" />
<meta property="og:description" content="devlog 5 du projet OpenRE" />
<meta name="twitter:description" content="devlog 5 du projet OpenRE" />

<meta property="og:locale" content="fr-fr" />
<meta name="language" content="fr-fr" />

  <link rel="alternate" hreflang="fr-fr" href="http://localhost:1313/projects/open_re_poc_devlog_5/" title="french" />






<meta name="generator" content="Hugo 0.137.0">

    
    <meta property="og:url" content="http://localhost:1313/projects/open_re_poc_devlog_5/">
  <meta property="og:site_name" content="Turbo Tartine Games">
  <meta property="og:title" content="OpenRE devlog 5 : Fusion des mondes. Part II">
  <meta property="og:description" content="devlog 5 du projet OpenRE">
  <meta property="og:locale" content="fr_fr">
  <meta property="og:type" content="article">
    <meta property="article:section" content="projects">
    <meta property="article:published_time" content="2025-08-31T12:54:28+02:00">
    <meta property="article:modified_time" content="2025-08-31T12:54:28+02:00">


    
    
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="OpenRE devlog 5 : Fusion des mondes. Part II">
  <meta name="twitter:description" content="devlog 5 du projet OpenRE">


    

    <link rel="canonical" href="http://localhost:1313/projects/open_re_poc_devlog_5/">
    <link href="/style.min.108c4c461b7a4c182434be799ba3436432548ccab41bdb394e0779285f20212e.css" rel="stylesheet">
    <link href="/code-highlight.min.706d31975fec544a864cb7f0d847a73ea55ca1df91bf495fd12a177138d807cf.css" rel="stylesheet">

    
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/icons/favicon-16x16.png">
    <link rel="mask-icon" href="/icons/safari-pinned-tab.svg">
    <link rel="shortcut icon" href="/favicon.ico">




<link rel="manifest" href="http://localhost:1313/site.webmanifest">

<meta name="msapplication-config" content="/browserconfig.xml">
<meta name="msapplication-TileColor" content="#2d89ef">
<meta name="theme-color" content="#434648">

    
    <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">

    
    
	
	
	<link rel="stylesheet" href="http://localhost:1313/css/togglecode.min.cb9bfee064f33d928a0183a1f9d86330cbadabb70a197c20e7265edad454eb3e.css">
</head>
<body data-theme = "dark" class="notransition">

<script src="/js/theme.js"></script>

<div class="navbar" role="navigation">
    <nav class="menu" aria-label="Main Navigation">
        <a href="http://localhost:1313/" class="logo">
            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" 
viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" 
stroke-linejoin="round" class="feather feather-home">
<title>Accueil</title>
<path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
<polyline points="9 22 9 12 15 12 15 22"></polyline>
</svg>
        </a>
        <input type="checkbox" id="menu-trigger" class="menu-trigger" />
        <label for="menu-trigger">
            <span class="menu-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7L3.40726 7"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488L3.49301 3.51488"></path><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"></path><path stroke-linecap="round" stroke-linejoin="round" d="M0.5 12.5V1.5C0.5 0.947715 0.947715 0.5 1.5 0.5H12.5C13.0523 0.5 13.5 0.947715 13.5 1.5V12.5C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C0.947715 13.5 0.5 13.0523 0.5 12.5Z"></path></svg>
            </span>
        </label>

        <div class="trigger">
            <ul class="trigger-container">
                
                
                <li>
                    <a class="menu-link " href="/">
                        Accueil
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link active" href="/projects/">
                        Projets
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/posts/">
                        Articles
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/glossary/">
                        Lexique
                    </a>
                    
                </li>
                
                <li>
                    <a class="menu-link " href="/pages/about/">
                        À propos
                    </a>
                    
                </li>
                
                <li class="menu-separator">
                    <span>|</span>
                </li>
                
                
            </ul>
            <a id="mode" href="#">
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-sunny" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>LIGHT</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
                <svg xmlns="http://www.w3.org/2000/svg" class="mode-moon" width="21" height="21" viewBox="0 0 14 14" stroke-width="1">
<title>DARK</title><g><circle cx="7" cy="7" r="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></circle><line x1="7" y1="0.5" x2="7" y2="2.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="2.4" x2="3.82" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="0.5" y1="7" x2="2.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="2.4" y1="11.6" x2="3.82" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="7" y1="13.5" x2="7" y2="11.5" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="11.6" x2="10.18" y2="10.18" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="13.5" y1="7" x2="11.5" y2="7" fill="none" stroke-linecap="round" stroke-linejoin="round"></line><line x1="11.6" y1="2.4" x2="10.18" y2="3.82" fill="none" stroke-linecap="round" stroke-linejoin="round"></line></g></svg>
            </a>
        </div>
    </nav>
</div>

<div class="wrapper post">
    <main class="page-content" aria-label="Content">
        <article>
            <header class="header">
                <h1 class="header-title">OpenRE devlog 5 : Fusion des mondes. Part II</h1>
                
                
                
                <div class="post-meta">
                    <time datetime="2025-08-31T12:54:28&#43;02:00" itemprop="datePublished"> 31 août 2025 </time>
                </div>
                
            </header>
            
    
    <details class="toc" ZgotmplZ>
        <summary><b>Table des matières</b></summary>
        <nav id="TableOfContents">
  <ul>
    <li><a href="#i-introduction">I. Introduction</a></li>
    <li><a href="#ii-le-modèle-de-lambert">II. Le modèle de Lambert</a>
      <ul>
        <li><a href="#1-principe">1. Principe</a></li>
        <li><a href="#2-implémentation">2. Implémentation</a>
          <ul>
            <li><a href="#11-introduction-des-normales">1.1. Introduction des normales</a></li>
            <li><a href="#12-echantillonage-des-normales">1.2. Echantillonage des normales</a></li>
            <li><a href="#13-selection-de-la-normale">1.3. Selection de la normale</a></li>
            <li><a href="#14-application-du-cosinus-de-lambert">1.4. Application du cosinus de Lambert</a></li>
            <li><a href="#15-résultat">1.5. Résultat</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#iii-lumière-déterministe">III. Lumière déterministe</a>
      <ul>
        <li><a href="#1-generation-des-textures-dillumination">1. Generation des textures d&rsquo;illumination</a></li>
        <li><a href="#2-intégration-au-compositor">2. Intégration au compositor</a>
          <ul>
            <li><a href="#21-introduction-des-maps-déterministe">2.1. Introduction des maps déterministe</a></li>
            <li><a href="#22-echantillonage-des-maps-déterministe">2.2. Echantillonage des maps déterministe</a></li>
            <li><a href="#23-reconstitution-de-la-lumière-déterministe">2.3. Reconstitution de la lumière déterministe</a></li>
          </ul>
        </li>
        <li><a href="#3-denoising">3. Denoising</a></li>
        <li><a href="#4-double-exposition">4. Double exposition</a></li>
      </ul>
    </li>
    <li><a href="#iv-conclusion">IV. Conclusion</a></li>
  </ul>
</nav>
    </details>
            <div class="page-content">
                <p><a href="/projects/open_re_poc_devlog_4/">⬅️ Vers Précédent : &ldquo;OpenRE devlog 5 : Fusion des mondes. Part I&rdquo;</a></p>
<h2 id="i-introduction">I. Introduction</h2>
<p>Bienvenue dans cette deuxième partie de &ldquo;fusion des mondes&rdquo; ! Le mois dernier nous avions mélangé de la géométrie intéractive à de la géométrie déterministe en nous basant sur les textures de profondeur. Nous avions ensuite éclairé tout ça avec une point light interactive qui clignotait en orbitant autour de la scène. L&rsquo;implémentation de l&rsquo;éclairage était basé uniquement sur la distance.</p>
<p>Aujourd&rsquo;hui nous allons :</p>
<ul>
<li>Enrichire le modèle d&rsquo;illumination en prenant en compte l&rsquo;orientation des surfaces</li>
<li>Calculer la lumière déterministe dans Blender et l&rsquo;intégrer a notre scène</li>
</ul>
<h2 id="ii-le-modèle-de-lambert">II. Le modèle de Lambert</h2>
<p>Le modèle de Lambert décrit des surfaces purement diffuses, c&rsquo;est à dire qui renvoient la lumière de manière égale dans toutes les directions. Cela veut dire que la quantité de lumière en un point ne dépend pas de l&rsquo;observateur mais seulement de l&rsquo;angle selon lequel le rayon frappe la surface.</p>
<p>C&rsquo;est le modèle que nous nous proposons d&rsquo;implémenter. D&rsquo;abord parce qu&rsquo;il est à peine plus compliqué que le précédent, mais surtout car comme nous l&rsquo;avons déjà évoqué, le G-Buffer interactif dont nous disposons ne possède pas encore les données nécessaires au calcule de la spéculaire.</p>
<h3 id="1-principe">1. Principe</h3>
<p>L&rsquo;intensitée apparente varie donc selon l&rsquo;angle d&rsquo;incidence de la lumière. Une façon de se représenter le phénomene, c&rsquo;est d&rsquo;imaginer un faiseau lumineux parfaitement vertical éclairant une surface parfaitement horizontale.</p>
<p>Le cercle dans lequel les photons percutent la surface cohincide avec la section du faiseau. Ou dit autrement :</p>
<div style="text-align:center;">
<p>&ldquo;soient <code>dL</code> le diamètre du faiseau et <code>dG</code> le diamètre du cercle projeté, on à : <code>dL = dG</code>&rdquo;</p>
</div> 
<br/>
<img alt="Schéma d'un vaiseau de lumière éclairant un plan orthogonal. Le projeté de sa section au sol est circulaire" src="./images/circle_ray.opti.webp" style="width:66%; display: block; margin-left: auto; margin-right: auto;" /> 
<p>Si maintenant le faiseau est incliné, <code>dG</code> s&rsquo;étire transformant notre cercle projeté en une élipse. L&rsquo;aire de cette élipse est évidament plus grande que celle du cercle alors que la quantité de photons emis, elle, reste la même. Ce qui se traduit par une baisse de la concentration lumineuse.</p>
<p><img alt="Schéma d&rsquo;un vaiseau de lumière rasant éclairant le même plan. Le projeté de sa section au sol est une élipse" src="/projects/open_re_poc_devlog_5/images/elipse_ray.opti.webp"></p>
<p>La décroissance de l&rsquo;intensité lumineuse est donc proportionnel à la croissance de l&rsquo;aire de l&rsquo;élipse, elle même fonction de l&rsquo;angle d&rsquo;incidence du faiseau. En posant tout ça, on peut déduire la fameuse &ldquo;loi du cosinus&rdquo; de Lambert. Laquelle décrit <code>I</code>, l&rsquo;intensité lumineuse perçue, comme :</p>
<div style="text-align:center;">
<p><code>I = I0 * cos(angle)</code></p>
<p>(avec <code>I0</code> l&rsquo;intensité de la source)</p>
</div> 
<p>Que l&rsquo;on peut aussi écrire :</p>
<div style="text-align:center;">
<p><code>I = I0 * (N.L)</code></p>
<p>(avec <code>N</code> la normale à la surface et <code>L</code> l&rsquo;inverse de la direction de la lumière)</p>
</div> 
<p>En gros, Lambert, c&rsquo;est basiquement multiplier votre lumière par <code>(N.L)</code></p>
<h3 id="2-implémentation">2. Implémentation</h3>
<p>En relisant le numéro précédent, je me suis rendu compte que les échantillons de code commencaient à être un peu long. J&rsquo;avais déjà du mal à les resituer dans la globalité, alors je n&rsquo;ose pas imaginer la galère pour quelqu&rsquo;un qui ne les a pas écrit.</p>
<p>Dans la partie II on va continuer d&rsquo;en rajouter et j&rsquo;avais peur que ça devienne vraiment illisible. J&rsquo;ai donc passé un peu de temps à développer une technologie révolutionnaire qui recontextualise l&rsquo;échantillon dans le code complet sous simple pression d&rsquo;un bouton (rigolez pas, je suis pas dev web, j&rsquo;ai mis ma vie pour faire ça alors il fallait que j&rsquo;en parle 😅). En tout cas j&rsquo;éspère que ça aidera à la lecture.</p>
<p>Bref, voici les ajouts nécessaire à l&rsquo;implémentation du modèle Lambertien. Comme toujours on va décortiquer ça pas à pas.</p>


  
  
  


<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS CODE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="11-introduction-des-normales">1.1. Introduction des normales</h4>
<p>Pour calculer l&rsquo;angle d&rsquo;incidence de la lumière, on va avoir besoin des normales (cette fois c&rsquo;est pas une blague, on va vraiment les utiliser ^^).



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS CODE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>
</p>
<p>On introduit donc les uniforms <code>i_normal_map</code> et <code>d_normal_map</code> qui proviennent respectivement des G-Buffers interactif et déterministe.</p>
<h4 id="12-echantillonage-des-normales">1.2. Echantillonage des normales</h4>
<p>Ensuite, on échantillone et on harmonise tout ça comme on l&rsquo;a fait pour les autres maps</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="13-selection-de-la-normale">1.3. Selection de la normale</h4>
<p>Puis on selectionne la normale du monde visible. Toujours en nous basant sur la profondeur.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="14-application-du-cosinus-de-lambert">1.4. Application du cosinus de Lambert</h4>
<p>Et enfin, on applique le terme Lambertien <code>NdotL</code> à notre calcule de l&rsquo;illumination.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<p>Si <code>NdotL</code> est négatif, cela indique que la face n&rsquo;est pas exposée à la lumière (c&rsquo;est à dire que les rayon la frappe &ldquo;par l&rsquo;arrière&rdquo;). Mais sommer une valeurs négative produirait un effet &ldquo;d&rsquo;absorbtion&rdquo; de la lumière déjà accumulée. Ce n&rsquo;est pas ce qu&rsquo;on veut, c&rsquo;est pourquoi on clamp <code>NdotL</code>.</p>
<h4 id="15-résultat">1.5. Résultat</h4>
<p>Cette implémentation nous donne un meilleur sens du relief grâce à un éclairage plus nuancé et aux self shadows qui se déssinent sur les faces non-exposées.</p>

 

<video width="100%" controls muted loop playsinline autoplay>
    <source src="videos/lambert.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


<p>Les ombre sont un peu sharp pour l&rsquo;instant, ce qui ne rend pas très naturel. Dans la vrai vie, quand un rayon de lumière percute une surface, certains photons rebondissent et vont s&rsquo;écraser ailleurs. On parle alors de lumière indirecte.</p>
<p>Contrairement à la lumière directe qui voyage en ligne droite, la lumière indirecte peut donc contourner les obstacles par rebonds successifs. Ainsi, elle peut affecter n&rsquo;importe quelle surface, notament les faces non-exposées. Son intensitée est moins forte car on perd de l&rsquo;énergie à chaque rebond (tous les photons ne sont pas réfléchis). Mais c&rsquo;est gràce à elle que dans la réalité, les ombres ne sont jamais completement noir.</p>
<img alt="Schéma illusterant la différence entre lumière directe et indirecte" src="./images/direct_indirect.opti.webp" style="width:66%; display: block; margin-left: auto; margin-right: auto;" /> 
<p>Notez que nos lumières déterministes ne sont pas sujetes à ce problème de noiceur des ombres car elles prennent justement en compte l&rsquo;éclairage indirecte. C&rsquo;est un des aspects qui les rend si interessante malgré le fait qu&rsquo;on ne peut pas les déplacer comme on veut. Voyons comment ça fonctionne.</p>
<h2 id="iii-lumière-déterministe">III. Lumière déterministe</h2>
<p>Avant toute chose, pour pouvoir calculer de la lumière déterministe, on va avoir besoin&hellip; d&rsquo;une lumière déterministe ! Il faut donc ajouter une point light à notre scene Blender.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/blender_point_light.opti.webp"><img alt="Capture d&rsquo;écran de blender montrant la scène avec une light en plus" src="/projects/open_re_poc_devlog_5/images/blender_point_light.opti.webp"></a></p>
<p>Cette point light sera automatiquement réimportée dans la scène godot par la magie de l&rsquo;interopérabilité des 2 logiciels. Mais il faudra tout de même l&rsquo;assigner aux uniforms correspondant de notre shader pour qu&rsquo;il puisse la prendre en compte (vous vous souvenez ? les 3 tableaux de taille fix un peu overkill de la partie I ?). Sans cela elle ne pourra pas éclairer les pixels interactifs.</p>
<p>D&rsquo;ailleurs c&rsquo;est le moment de déterrer le tableau récapitulatif de l&rsquo;article principal pour nous remettre au point sur les différents cas :</p>
<style>
table th:first-of-type {
    width: 10%;
}
table th:nth-of-type(2) {
    width: 50%;
}
table th:nth-of-type(3) {
    width: 30%;
}
</style>
<table>
  <thead>
      <tr>
          <th></th>
          <th style="text-align: center">Pixel Déterministe</th>
          <th style="text-align: center">Pixel Interactif</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Lumière Déterministe</strong></td>
          <td style="text-align: center">Précalculé</td>
          <td style="text-align: center">Temps Réèl</td>
      </tr>
      <tr>
          <td><strong>Lumière Interactive</strong></td>
          <td style="text-align: center">Précalculé + Temps Réèl</td>
          <td style="text-align: center">Temps Réèl</td>
      </tr>
  </tbody>
</table>
<p>Le shader actuel n&rsquo;accumule pour l&rsquo;instant que la partie temps réèl de chaque lumière. Pour compléter le tableau, il va donc falloir précalculer la partie déterministe dans Blender, et l&rsquo;appliquer aux pixels déterministes.</p>
<h3 id="1-generation-des-textures-dillumination">1. Generation des textures d&rsquo;illumination</h3>
<p>Comme à chaque fois qu&rsquo;on touche à Blender, on va activer de nouvelles passes et modifier le compositor pour générer de nouvelles maps afin d&rsquo;enrichir notre G-Buffer déterministe. Cette fois ci, les passes cycle qui nous interessent sont au nombre de 5 :</p>
<ul>
<li>diffuse directe</li>
<li>diffuse indirecte</li>
<li>glossy directe</li>
<li>glossy indirecte</li>
<li>glossy color</li>
</ul>
<p>Techniquement la diffuse color nous interesse aussi mais il se trouve qu&rsquo;on l&rsquo;a déjà (souvenez vous, c&rsquo;est notre albédo).</p>
<p>De là vous connaissez la musique, :</p>
<ul>
<li>On active les passes dans le paneau latéral</li>
<li>On ajoute les pins nécessaires au noeud File Output</li>
<li>On relie les sorties de chaque passes aux pins correspondant et on appuie sur F12 pour lancer le rendu</li>
</ul>
<p><a href="/projects/open_re_poc_devlog_5/images/blender_passes.opti.webp"><img alt="Capture d&rsquo;écran montrant comment activer les pass d&rsquo;illumination de Cycles" src="/projects/open_re_poc_devlog_5/images/blender_passes.opti.webp"></a></p>
<p>Petit point vocabulaire pour bien comprendre à quoi correspondent toutes ces données :</p>
<ul>
<li><strong>diffuse :</strong> correspond à la composantes diffuse de la lumière</li>
<li><strong>glossy :</strong> correspond à la composantes spéculaire de la lumière</li>
<li><strong>direct :</strong> contribution des rayons de première visibilité (lumière directe)</li>
<li><strong>indirect :</strong> contribution des rebonds successifs (lumière indirecte)</li>
</ul>
<p>En gros, plutôt que de nous donner directement l&rsquo;accumulation totale de toutes les contributions lumineuse de la scène, Blender les regroupe par paquet et nous laisse le soin de les recombiner comme on veut. Ce qui donne à l&rsquo;utilisateur une plus grande liberté artistique.</p>
<p>Je ne sais pas encore si on aura l&rsquo;utilisté de ce découpage dans OpenRE. Dans le doute on le garde pour se laisser l&rsquo;oportunité d&rsquo;experimenter plus tard. Mais si on ne s&rsquo;en sert pas, il faudra biensure recomposer tout ça directement dans Blender avant export. On va pas se trimbaler 5 textures quand on peut n&rsquo;en manipuler qu&rsquo;une seule.</p>
<h3 id="2-intégration-au-compositor">2. Intégration au compositor</h3>
<p>C&rsquo;est maintenant une habitude, voici d&rsquo;un bloc la totalité des ajout que l&rsquo;on s&rsquo;apprete à détailler. L&rsquo;objectif ici est que notre shader soit en capacité de gérer la lumière déterministe que l&rsquo;on vient de générer.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS CODE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="21-introduction-des-maps-déterministe">2.1. Introduction des maps déterministe</h4>
<p>On doit biensure lui donner les textures via des uniforms.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="22-echantillonage-des-maps-déterministe">2.2. Echantillonage des maps déterministe</h4>
<p>Ensuite, on échantillonne ces textures de la même manière que les autres. Mais cette fois ci, il n&rsquo;y a pas d&rsquo;harmonisation a effectuer car ces données sont exclusivent au monde déterministe.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<h4 id="23-reconstitution-de-la-lumière-déterministe">2.3. Reconstitution de la lumière déterministe</h4>
<p>Ici nous allons initialiser les variable <code>diffuse_contrib</code> et <code>specular_contrib</code> selon la formule indiquée dans la documention de Blender.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/blender_compo_formula.opti.webp"><img alt="Schéma issue de la documentation de godot indiquant comment rzeconstituer les maps des différentes passes" src="/projects/open_re_poc_devlog_5/images/blender_compo_formula.opti.webp"></a></p>
<p>Comme le disait le tableau récapitulatif, la lumière déterministe générée dans Blender ne s&rsquo;applique pas aux fragments intéractifs. C&rsquo;est la raison pour laquelle on initialise les variables dans le <code>else</code> du bloc de sélection des données.</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line hl"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<p>Ainsi, la suite du shader accumule naturellement la lumière temps réèl par dessus la lumière précalculée que l&rsquo;on vient de reconstituer, et on obtien le résultat suivant :</p>

 

<video width="100%" controls muted loop playsinline autoplay>
    <source src="videos/burned_noise.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


<h3 id="3-denoising">3. Denoising</h3>
<p>Quand on regarde tout ça de près, on peut voir que le rendu n&rsquo;est pas très propre.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/det_noise_zoom.opti.webp"><img alt="Capture zoomée de la scene, mettant en evidence le bruit de l&rsquo;image" src="/projects/open_re_poc_devlog_5/images/det_noise_zoom.opti.webp"></a></p>
<p>Si on s&rsquo;interesse aux maps d&rsquo;indirect générées par Blender, on comprend vite pourquoi.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/noise_indirect.webp"><img alt="Caplture zoomée mettant en evidence le bruit sur les images d&rsquo;origine &ldquo;Diffuse Indirect&rdquo; et &ldquo;Glossy Indirect&rdquo;" src="/projects/open_re_poc_devlog_5/images/noise_indirect.webp"></a></p>
<p><em>&ldquo;Garbage in =&gt; garbage out !&rdquo;</em> Il n&rsquo;y a pas de miracle, si vos données d&rsquo;entrées sont sales, aucune chance d&rsquo;avoir quelque chose de propre en sortie.</p>
<p><strong>Mais pourquoi Blender fait des rendu tout dégeux d&rsquo;abord ?</strong></p>
<p>Et bien en fait c&rsquo;est normal. Toutes les images générées par <em>path tracing</em> sont bruitées, et c&rsquo;est comme ça que sont produites les maps d&rsquo;indirect. Si on veut de la netteté, il faut les denoiser. Blender en est biensure capable. Il ne le fait simplement pas par defaut.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/blender_denoise_node.opti.webp"><img alt="Capture du compositeur de Blender auquel on a ajouté les noeuds dénoise" src="/projects/open_re_poc_devlog_5/images/blender_denoise_node.opti.webp"></a></p>
<p>Il suffit d&rsquo;utiliser le noeud <code>Denoise</code> dans le <code>Compositeur</code> et le tour est joué.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/denoised_indirect.webp"><img alt="Caplture zoomée mettant en evidence l&rsquo;abscence de bruit après denoising dans blender&quot;" src="/projects/open_re_poc_devlog_5/images/denoised_indirect.webp"></a></p>
<p>Evidement le denoising augment le temps de rendu. Mais c&rsquo;est le prix pour avoir un rendu de qualité.</p>
<p><a href="/projects/open_re_poc_devlog_5/images/det_denoise_zoom.opti.webp"><img alt="Capture zoomée de la scene, mettant en evidence l&rsquo;abscence de bruit" src="/projects/open_re_poc_devlog_5/images/det_denoise_zoom.opti.webp"></a></p>
<h3 id="4-double-exposition">4. Double exposition</h3>
<p>Le resultat actuel est plutôt pas mal. Mais si vous avez l&rsquo;oeil, vous aurez surement remarqué que la lumière déterministe est quelques peu sur-vitaminée.</p>
<p>Là raison est simple. Notre shader ne fait pas de distinction selon type de lumière lors de l&rsquo;accumulation des contributions. Pour un pixel interactif c&rsquo;est exactement ce qu&rsquo;on veut : si un personnage s&rsquo;approche d&rsquo;une source déterministe, on a envie que sa lumière l&rsquo;affecte.</p>
<p>Mais pour un pixel déterministe, c&rsquo;est un probleme ! En effet, l&rsquo;accumulation des lumières déterministes sur l&rsquo;environnement déterministe à déjà été calculés par Blender. Elle est stoqué dans les maps d&rsquo;illumination que l&rsquo;on vient d&rsquo;intégrer. Comme le calcul est refait sans distinction côté Godot, ces lumières sont prises en compte 2 fois. C&rsquo;est pour ça que ça patate aussi fort. (d&rsquo;ailleurs si j&rsquo;avais lu correctement mon tableau récapitulatif, j&rsquo;aurait pu l&rsquo;anticiper ^^)</p>
<p><a href="/projects/open_re_poc_devlog_5/images/det_burned_zoom.opti.webp"><img alt="Capture zoomée de la scene, mettant en evidence l&rsquo;intensité trop forte de la lumière qui brûle l&rsquo;image" src="/projects/open_re_poc_devlog_5/images/det_burned_zoom.opti.webp"></a></p>
<p>Le shader à donc besoin de savoir à quel monde appartiennent les lumières qu&rsquo;il traite. On lui fait part de cet information à travers un nouveau uniform <code>plight_isInteractive</code>. Il s&rsquo;en sert lors de l&rsquo;accumulation pour filtrer le cas &ldquo;lumiere déterministe sur pixel déterministe&rdquo; (qui n&rsquo;a pas de composante temps réèl).</p>



<div class="togglecode">
  <div class="highlight" id="code-compact"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS CODE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">bool</span> <span class="n">plight_isInteractive</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">is_frag_interactive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plight_isInteractive</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line hl"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="p">...</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><div class="highlight hidden" id="code-full"><pre tabindex="0" class="chroma"><code class="language-glsl" data-lang="glsl"><span class="line"><span class="cl"><span class="c1">// USUAL GODOT POST-PROCESS STUFF</span>
</span></span><span class="line"><span class="cl"><span class="n">shader_type</span> <span class="n">spatial</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">render_mode</span> <span class="n">unshaded</span><span class="p">,</span> <span class="n">fog_disabled</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">vertex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">POSITION</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">VERTEX</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// HELPER FUNCTIONS FROM THE ORACLE</span>
</span></span><span class="line"><span class="cl"><span class="cp">#include &#34;pre_process_utils.gdshaderinc&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// SCENE UNIFORMS</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_near</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">cam_far</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">int</span> <span class="n">nb_plights</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_position</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">vec3</span> <span class="n">plight_color</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">float</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line hl"><span class="cl"><span class="k">uniform</span> <span class="k">bool</span> <span class="n">plight_isInteractive</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// INTERACTIVE G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_albedo_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">i_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// DETERMINIST G-BUFFER</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_depth_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diffuse_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_normal_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_diff_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_color_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_dir_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">uniform</span> <span class="k">sampler2D</span> <span class="n">d_gloss_ind_map</span> <span class="o">:</span> <span class="n">filter_nearest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">void</span> <span class="n">fragment</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1">// SAMPLE G-BUFFERs</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_albedo_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_albedo_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">i_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_depth_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diffuse_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diffuse_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_normal_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_diff_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_diff_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_color_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_color_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_dir_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_dir_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">d_gloss_ind_frag</span> <span class="o">=</span> <span class="n">texture</span><span class="p">(</span><span class="n">d_gloss_ind_map</span><span class="p">,</span> <span class="n">SCREEN_UV</span><span class="p">).</span><span class="n">rgb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA HARMONIZATION</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_i_depth</span><span class="p">(</span><span class="n">i_depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_depth_frag</span> <span class="o">=</span> <span class="n">pre_process_d_depth</span><span class="p">(</span><span class="n">d_depth_frag</span><span class="p">,</span> <span class="n">cam_near</span><span class="p">,</span> <span class="n">cam_far</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">d_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_d_normal</span><span class="p">(</span><span class="n">d_normal_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="n">i_normal_frag</span> <span class="o">=</span> <span class="n">pre_process_i_normal</span><span class="p">(</span><span class="n">i_normal_frag</span><span class="p">,</span> <span class="n">INV_VIEW_MATRIX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">diffuse_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">specular_contrib</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// DATA SELECTION (according to depth)</span>
</span></span><span class="line"><span class="cl">	<span class="k">float</span> <span class="n">depth_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">bool</span> <span class="n">is_frag_interactive</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span> <span class="o">&lt;</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span><span class="p">(</span><span class="n">is_frag_interactive</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">i_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">i_albedo_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">i_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">depth_frag</span> <span class="o">=</span> <span class="n">d_depth_frag</span><span class="p">.</span><span class="n">r</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">albedo_frag</span> <span class="o">=</span> <span class="n">d_diffuse_color_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">normal_frag</span> <span class="o">=</span> <span class="n">d_normal_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_diff_light</span> <span class="o">=</span> <span class="n">d_diff_dir_frag</span> <span class="o">+</span> <span class="n">d_diff_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">d_gloss_light</span> <span class="o">=</span> <span class="n">d_gloss_dir_frag</span> <span class="o">+</span> <span class="n">d_gloss_ind_frag</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">d_diffuse_color_frag</span> <span class="o">*</span> <span class="n">d_diff_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">specular_contrib</span> <span class="o">+=</span> <span class="n">d_gloss_color_frag</span> <span class="o">*</span> <span class="n">d_gloss_light</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// WORLD POSITION FROM DEPTH</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">ndc</span> <span class="o">=</span> <span class="k">vec3</span><span class="p">((</span><span class="n">SCREEN_UV</span> <span class="o">*</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">depth_frag</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">clip</span> <span class="o">=</span> <span class="k">vec4</span><span class="p">(</span><span class="n">ndc</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec4</span> <span class="n">world</span> <span class="o">=</span> <span class="n">INV_VIEW_MATRIX</span> <span class="o">*</span> <span class="n">INV_PROJECTION_MATRIX</span> <span class="o">*</span> <span class="n">clip</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">world</span><span class="p">.</span><span class="n">xyz</span> <span class="o">/=</span> <span class="n">world</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="k">vec3</span> <span class="n">frag_position</span> <span class="o">=</span> <span class="n">world</span><span class="p">.</span><span class="n">xyz</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// ACCUMULATE LIGHT CONTRIBUTIONS</span>
</span></span><span class="line"><span class="cl">	<span class="k">for</span><span class="p">(</span><span class="k">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mo">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb_plights</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line hl"><span class="cl">		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">is_frag_interactive</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">plight_isInteractive</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span></span><span class="line hl"><span class="cl">			<span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">light_vec</span> <span class="o">=</span> <span class="n">plight_position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">frag_position</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">light_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">d2</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">attenuation</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">d2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">		<span class="k">vec3</span> <span class="n">C</span> <span class="o">=</span> <span class="n">plight_color</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">I</span> <span class="o">=</span> <span class="n">plight_intensity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">		<span class="k">float</span> <span class="n">NdotL</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">dot</span><span class="p">(</span><span class="n">normal_frag</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="n">diffuse_contrib</span> <span class="o">+=</span> <span class="n">NdotL</span> <span class="o">*</span> <span class="n">C</span> <span class="o">*</span> <span class="n">I</span> <span class="o">*</span> <span class="n">albedo_frag</span> <span class="o">*</span> <span class="n">attenuation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="c1">//specular_contrib += NOT IMPLEMENTED YET</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	
</span></span><span class="line"><span class="cl">	<span class="c1">// FINAL FRAGMENT COLOR</span>
</span></span><span class="line"><span class="cl">	<span class="n">ALBEDO</span> <span class="o">=</span> <span class="n">diffuse_contrib</span> <span class="o">+</span> <span class="n">specular_contrib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div>
  <button class="toggle-btn" onclick="toggleCode(this)">Full Code</button>
</div>

<p>Ce qui nous laisse avec ce magnifique rendu :</p>

 

<video width="100%" controls muted loop playsinline autoplay>
    <source src="videos/final.mp4" type="video/mp4">
    Your browser does not support the video tag.  
</video>


<h2 id="iv-conclusion">IV. Conclusion</h2>
<p>On commence à arriver sur quelque chose de convainquant. Sur la partie temps réèl, le modèle de Lambert est certes un peu léger en comparaison de ce qui se fait aujourd&rsquo;hui. Mais sans spéculaire on peut malheureusement pas faire beaucup mieux. C&rsquo;est pourquoi dans le prochain épisode, on s&rsquo;attaquera à l&rsquo;harmonisation de l&rsquo;ORM en vu de l&rsquo;implémentation d&rsquo;un modèle PBR.</p>
<p>Ceci étant dit, je trouve que même en l&rsquo;état, Lambert ne s&rsquo;en sort pas trop mal dès lors qu&rsquo;on y ajoute la lumière déterministe précalculée. On a déjà de la spéculaire, de la lumière indirect et on se paie même le luxe d&rsquo;une superbe ombre portée (qui ignore la géométrie interactive oui ça va je sais&hellip;).</p>
<p>Les deux mondes ne sont pas totalement indicernables, mais il faut quand même regargarder la scène de près pour voire la supercherie. Il faudra biensure confirmer cela sur un scène un peu plus réaliste mais c&rsquo;est assez prometteur.</p>
<p>Ainsi s&rsquo;achève cette première mise en application des principe d&rsquo;OpenRE. Je suis contant de pouvoir enfin vous montrer quelque résultats (après 6 numéros répartis sur 6 mois, il était temps héhé). Mais on as encore pas mal de sujets à couvrir dans ce POC avant de passer au SDK. J&rsquo;espère que ça vous plais toujours. En tout cas ça me fait très plaisir de voire que plusieurs personnes suivent l&rsquo;aventure. Salut à vous ! Merci d&rsquo;être là ! Et à bientôt 👋</p>

            </div>
        </article>
<hr style="margin-top: 40px; margin-bottom: 40px;" />
<div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "turbo-tartine-games-blog" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>
</div>
<footer class="footer">
    <span class="footer_item"> </span>
    &nbsp;

    <div class="footer_social-icons">
<a href="https://github.com/J-Ponzo" target="_blank" rel="noopener noreferrer me"
    title="Github">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22">
    </path>
</svg>
</a>
<a href="https://jponzo.itch.io" target="_blank" rel="noopener noreferrer me"
    title="Itchio">
    <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 245.371 220.736">
    <path
        d="M31.99 1.365C21.287 7.72.2 31.945 0 38.298v10.516C0 62.144 12.46 73.86 23.773 73.86c13.584 0 24.902-11.258 24.903-24.62 0 13.362 10.93 24.62 24.515 24.62 13.586 0 24.165-11.258 24.165-24.62 0 13.362 11.622 24.62 25.207 24.62h.246c13.586 0 25.208-11.258 25.208-24.62 0 13.362 10.58 24.62 24.164 24.62 13.585 0 24.515-11.258 24.515-24.62 0 13.362 11.32 24.62 24.903 24.62 11.313 0 23.773-11.714 23.773-25.046V38.298c-.2-6.354-21.287-30.58-31.988-36.933C180.118.197 157.056-.005 122.685 0c-34.37.003-81.228.54-90.697 1.365zm65.194 66.217a28.025 28.025 0 0 1-4.78 6.155c-5.128 5.014-12.157 8.122-19.906 8.122a28.482 28.482 0 0 1-19.948-8.126c-1.858-1.82-3.27-3.766-4.563-6.032l-.006.004c-1.292 2.27-3.092 4.215-4.954 6.037a28.5 28.5 0 0 1-19.948 8.12c-.934 0-1.906-.258-2.692-.528-1.092 11.372-1.553 22.24-1.716 30.164l-.002.045c-.02 4.024-.04 7.333-.06 11.93.21 23.86-2.363 77.334 10.52 90.473 19.964 4.655 56.7 6.775 93.555 6.788h.006c36.854-.013 73.59-2.133 93.554-6.788 12.883-13.14 10.31-66.614 10.52-90.474-.022-4.596-.04-7.905-.06-11.93l-.003-.045c-.162-7.926-.623-18.793-1.715-30.165-.786.27-1.757.528-2.692.528a28.5 28.5 0 0 1-19.948-8.12c-1.862-1.822-3.662-3.766-4.955-6.037l-.006-.004c-1.294 2.266-2.705 4.213-4.563 6.032a28.48 28.48 0 0 1-19.947 8.125c-7.748 0-14.778-3.11-19.906-8.123a28.025 28.025 0 0 1-4.78-6.155 27.99 27.99 0 0 1-4.736 6.155 28.49 28.49 0 0 1-19.95 8.124c-.27 0-.54-.012-.81-.02h-.007c-.27.008-.54.02-.813.02a28.49 28.49 0 0 1-19.95-8.123 27.992 27.992 0 0 1-4.736-6.155zm-20.486 26.49l-.002.01h.015c8.113.017 15.32 0 24.25 9.746 7.028-.737 14.372-1.105 21.722-1.094h.006c7.35-.01 14.694.357 21.723 1.094 8.93-9.747 16.137-9.73 24.25-9.746h.014l-.002-.01c3.833 0 19.166 0 29.85 30.007L210 165.244c8.504 30.624-2.723 31.373-16.727 31.4-20.768-.773-32.267-15.855-32.267-30.935-11.496 1.884-24.907 2.826-38.318 2.827h-.006c-13.412 0-26.823-.943-38.318-2.827 0 15.08-11.5 30.162-32.267 30.935-14.004-.027-25.23-.775-16.726-31.4L46.85 124.08C57.534 94.073 72.867 94.073 76.7 94.073zm45.985 23.582v.006c-.02.02-21.863 20.08-25.79 27.215l14.304-.573v12.474c0 .584 5.74.346 11.486.08h.006c5.744.266 11.485.504 11.485-.08v-12.474l14.304.573c-3.928-7.135-25.79-27.215-25.79-27.215v-.006l-.003.002z" />
</svg>
</a>
<a href="https://@turbotartine.bsky.social" target="_blank" rel="noopener noreferrer me"
    title="Bluesky">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" stroke="none" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
    d="M11.999,10.236c0.321,-0.524 0.916,-1.507 1.405,-2.376c0.755,-1.344 1.692,-2.852 2.869,-4.028c1.283,-1.281 2.845,-2.171 4.739,-2.171c1.144,-0 1.864,0.585 2.299,1.497c0.486,1.017 0.545,2.551 0.51,3.883c-0.051,1.945 -0.232,3.337 -0.505,4.275c-0.229,0.786 -0.543,1.303 -0.878,1.615c-0.892,0.833 -1.8,1.263 -2.634,1.484c0.029,0.018 0.056,0.036 0.084,0.055c0.528,0.367 0.823,0.79 1.081,1.107c0.648,0.794 0.644,1.795 0.23,2.784c-0.481,1.151 -1.533,2.279 -2.12,2.773c-1.389,1.171 -2.506,1.362 -3.383,1.133c-0.88,-0.23 -1.59,-0.932 -2.156,-1.826c-0.45,-0.71 -0.817,-1.537 -1.176,-2.186c-0.115,-0.208 -0.302,-0.455 -0.406,-0.587c-0.02,0.019 -0.04,0.04 -0.056,0.058c-0.121,0.145 -0.234,0.328 -0.349,0.531c-0.363,0.644 -0.721,1.463 -1.157,2.166c-0.555,0.895 -1.252,1.597 -2.12,1.825c-0.863,0.227 -1.97,0.037 -3.363,-1.136c-0.586,-0.494 -1.638,-1.622 -2.119,-2.773c-0.414,-0.989 -0.418,-1.99 0.229,-2.784c0.258,-0.317 0.554,-0.74 1.082,-1.106c0.027,-0.019 0.055,-0.038 0.084,-0.056c-0.834,-0.221 -1.742,-0.651 -2.634,-1.484c-0.335,-0.312 -0.649,-0.829 -0.878,-1.615c-0.273,-0.938 -0.454,-2.33 -0.505,-4.275c-0.036,-1.332 0.024,-2.866 0.509,-3.883c0.435,-0.912 1.156,-1.497 2.3,-1.497c2.32,0 4.109,1.203 5.494,2.808c1.272,1.474 2.195,3.283 2.9,4.643c0.231,0.447 0.436,0.84 0.624,1.146Zm-0.01,5.653l0.296,0.031l0.271,0.086c0.208,0.088 0.413,0.229 0.607,0.428c0.455,0.467 0.882,1.369 1.36,2.284c0.249,0.477 0.518,0.958 0.841,1.339c0.231,0.274 0.483,0.502 0.805,0.569c0.488,0.103 1.052,-0.157 1.811,-0.797c0.452,-0.38 1.274,-1.239 1.645,-2.126c0.155,-0.371 0.265,-0.75 0.022,-1.048c-0.179,-0.22 -0.366,-0.529 -0.732,-0.783c-0.536,-0.372 -1.356,-0.51 -1.905,-0.654c-0.405,-0.106 -0.715,-0.234 -0.88,-0.355l-0.284,-0.303l-0.135,-0.367l-0.008,-0.211l0.035,-0.196l0.078,-0.195l0.142,-0.209l0.198,-0.181l0.296,-0.154c0.151,-0.055 0.348,-0.092 0.587,-0.104c0.815,-0.042 2.571,0.294 4.235,-1.259c0.171,-0.159 0.288,-0.445 0.404,-0.845c0.246,-0.843 0.391,-2.096 0.438,-3.843c0.024,-0.91 0.026,-1.938 -0.208,-2.738c-0.142,-0.486 -0.367,-0.891 -0.896,-0.891c-1.675,0 -2.974,0.983 -4.031,2.21c-1.179,1.369 -2.058,3.057 -2.752,4.321c-0.483,0.88 -0.902,1.573 -1.25,1.916c-0.088,0.086 -0.174,0.157 -0.257,0.214l-0.221,0.125l-0.228,0.078l-0.267,0.031l-0.274,-0.034l-0.231,-0.083l-0.219,-0.132c-0.081,-0.058 -0.164,-0.131 -0.248,-0.22c-0.327,-0.343 -0.718,-1.037 -1.174,-1.917c-0.654,-1.262 -1.497,-2.948 -2.676,-4.314c-1.067,-1.236 -2.417,-2.217 -4.203,-2.217c-0.53,0 -0.754,0.405 -0.896,0.891c-0.234,0.8 -0.232,1.828 -0.208,2.738c0.046,1.747 0.192,3 0.438,3.843c0.116,0.4 0.233,0.686 0.403,0.845c1.665,1.553 3.421,1.217 4.235,1.259c0.24,0.012 0.437,0.049 0.588,0.104l0.295,0.154l0.199,0.181l0.142,0.209l0.078,0.195l0.035,0.196l-0.009,0.211l-0.135,0.368l-0.283,0.303c-0.165,0.12 -0.476,0.248 -0.88,0.355c-0.549,0.144 -1.369,0.281 -1.905,0.653c-0.366,0.254 -0.554,0.564 -0.732,0.783c-0.243,0.298 -0.133,0.677 0.022,1.048c0.371,0.887 1.193,1.746 1.645,2.127c0.757,0.637 1.311,0.9 1.789,0.8c0.311,-0.066 0.55,-0.29 0.772,-0.557c0.315,-0.381 0.577,-0.86 0.822,-1.337c0.394,-0.763 0.752,-1.521 1.138,-2.01c0.431,-0.544 0.929,-0.815 1.455,-0.815Z" style="fill-rule:nonzero;"/>
</svg>
</a>
<a href="https://mastodon.gamedev.place/@TurboTartine" target="_blank" rel="noopener noreferrer me"
    title="Mastodon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path
        d="M21.58 13.913c-.29 1.469-2.592 3.121-5.238 3.396-1.379.184-2.737.368-4.185.276-2.368-.092-4.237-.551-4.237-.551 0 .184.014.459.043.643.308 2.294 2.317 2.478 4.22 2.57 1.922 0 3.633-.46 3.633-.46l.079 1.653s-1.344.734-3.738.918c-1.32.091-2.96-.092-4.869-.551-4.14-1.102-4.853-5.507-4.961-10.005-.034-1.285-.013-2.57-.013-3.58 0-4.589 3-5.966 3-5.966 1.513-.734 4.11-1.01 6.808-1.01h.067c2.699 0 5.296.276 6.81 1.01 0 0 3 1.377 3 5.967 0 0 .037 3.304-.419 5.69"
        stroke="currentColor" />
    <path
        d="M17.832 8.633v5h-1.978V8.78c0-1.023-.43-1.542-1.29-1.542-.95 0-1.427.616-1.427 1.834v2.655H11.17V9.072c0-1.218-.476-1.834-1.427-1.834-.86 0-1.29.52-1.29 1.542v4.852H6.475V8.633c0-1.022.26-1.834.782-2.434.538-.6 1.243-.909 2.118-.909 1.012 0 1.779.39 2.286 1.169l.492.827.493-.827c.507-.78 1.274-1.169 2.286-1.169.875 0 1.58.308 2.118.909.522.6.782 1.412.782 2.434"
        fill="currentColor" stroke="none" />
</svg>
</a>
<a href="/index.xml" target="_blank" rel="noopener noreferrer me"
    title="Rss">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
    stroke-linecap="round" stroke-linejoin="round">
    <path d="M4 11a9 9 0 0 1 9 9" />
    <path d="M4 4a16 16 0 0 1 16 16" />
    <circle cx="5" cy="19" r="1" />
</svg>
</a>
</div>
    <small class="footer_copyright">
        © 2025 J-Ponzo(TurboTartine).
        Propulsé par <a href="https://github.com/hugo-sid/hugo-blog-awesome" target="_blank" rel="noopener">Hugo blog awesome</a>.
    </small>
</footer><a href="#" title="Aller en haut" id="totop">
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" stroke="currentColor" viewBox="0 96 960 960">
    <path d="M283 704.739 234.261 656 480 410.261 725.739 656 677 704.739l-197-197-197 197Z"/>
</svg>

</a>


    




    
    
        
    

    
    
        
    



    
    <script async src="http://localhost:1313/js/main.js" ></script>

    


		<script src="http://localhost:1313/js/togglecode.min.20d8a7e249c5cfc719fa54b9545592036db0fee4e0ea851f283f820460c5b07b.js" defer></script>
    </body>
</html>
